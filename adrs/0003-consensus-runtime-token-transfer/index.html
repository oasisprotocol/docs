<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-adrs/0003-consensus-runtime-token-transfer" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">ADR 0003: Consensus/Runtime Token Transfer | Oasis Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.oasis.io/adrs/0003-consensus-runtime-token-transfer"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="ADR 0003: Consensus/Runtime Token Transfer | Oasis Documentation"><meta data-rh="true" name="description" content="Component"><meta data-rh="true" property="og:description" content="Component"><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://docs.oasis.io/adrs/0003-consensus-runtime-token-transfer"><link data-rh="true" rel="alternate" href="https://docs.oasis.io/adrs/0003-consensus-runtime-token-transfer" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.oasis.io/adrs/0003-consensus-runtime-token-transfer" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.e55d6d10.css">
<script src="/assets/js/runtime~main.296dd946.js" defer="defer"></script>
<script src="/assets/js/main.1fc431be.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><link rel="preload" as="image" href="/img/logo_dark.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Oasis Docs" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo_dark.svg" alt="Oasis Docs" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/build/">Build</a><a class="navbar__item navbar__link" href="/general/">Learn</a><a class="navbar__item navbar__link" href="/get-involved/">Get Involved</a><a class="navbar__item navbar__link" href="/node/">Run Node</a><a class="navbar__item navbar__link" href="/core/">Develop Core</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/oasisprotocol" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" title="GitHub repository" aria-label="GitHub repository"></a><a href="https://oasis.net/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-www-link" title="Oasis website" aria-label="Oasis website"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/adrs"><span title="Architectural Decision Records" class="categoryLinkLabel_W154">Architectural Decision Records</span></a><button aria-label="Collapse sidebar category &#x27;Architectural Decision Records&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0001-tm-multi-root-apphash"><span title="ADR 0001: Multiple Roots Under the Tendermint Application Hash" class="linkLabel_WmDU">ADR 0001: Multiple Roots Under the Tendermint Application Hash</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0002-go-modules-compatible-git-tags"><span title="ADR 0002: Go Modules Compatible Git Tags" class="linkLabel_WmDU">ADR 0002: Go Modules Compatible Git Tags</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/adrs/0003-consensus-runtime-token-transfer"><span title="ADR 0003: Consensus/Runtime Token Transfer" class="linkLabel_WmDU">ADR 0003: Consensus/Runtime Token Transfer</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0004-runtime-governance"><span title="ADR 0004: Runtime Governance" class="linkLabel_WmDU">ADR 0004: Runtime Governance</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0005-runtime-compute-slashing"><span title="ADR 0005: Runtime Compute Node Slashing" class="linkLabel_WmDU">ADR 0005: Runtime Compute Node Slashing</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0006-consensus-governance"><span title="ADR 0006: Consensus Governance" class="linkLabel_WmDU">ADR 0006: Consensus Governance</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0007-improved-random-beacon"><span title="ADR 0007: Improved Random Beacon" class="linkLabel_WmDU">ADR 0007: Improved Random Beacon</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0008-standard-account-key-generation"><span title="ADR 0008: Standard Account Key Generation" class="linkLabel_WmDU">ADR 0008: Standard Account Key Generation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0009-ed25519-semantics"><span title="ADR 0009: Ed25519 Signature Verification Semantics" class="linkLabel_WmDU">ADR 0009: Ed25519 Signature Verification Semantics</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0010-vrf-elections"><span title="ADR 0010: VRF-based Committee Elections" class="linkLabel_WmDU">ADR 0010: VRF-based Committee Elections</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0011-incoming-runtime-messages"><span title="ADR 0011: Incoming Runtime Messages" class="linkLabel_WmDU">ADR 0011: Incoming Runtime Messages</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0012-runtime-message-results"><span title="ADR 0012: Runtime Message Results" class="linkLabel_WmDU">ADR 0012: Runtime Message Results</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0013-runtime-upgrades"><span title="ADR 0013: Runtime Upgrade Improvements" class="linkLabel_WmDU">ADR 0013: Runtime Upgrade Improvements</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0014-runtime-signing-tx-with-hardware-wallet"><span title="ADR 0014: Signing Runtime Transactions with Hardware Wallet" class="linkLabel_WmDU">ADR 0014: Signing Runtime Transactions with Hardware Wallet</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0015-vrf-per-block-entropy"><span title="ADR 0015: Randomized Paratime Proposer Selection" class="linkLabel_WmDU">ADR 0015: Randomized Paratime Proposer Selection</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0016-consensus-parameters-change-proposal"><span title="ADR 0016: Consensus Parameters Change Proposal" class="linkLabel_WmDU">ADR 0016: Consensus Parameters Change Proposal</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0017-app-standards"><span title="ADR 0017: ParaTime Application Standard Proposal Process" class="linkLabel_WmDU">ADR 0017: ParaTime Application Standard Proposal Process</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0020-governance-delegator-votes"><span title="ADR 0020: Governance Support for Delegator Votes" class="linkLabel_WmDU">ADR 0020: Governance Support for Delegator Votes</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0021-keymanager-ephemeral-secrets"><span title="ADR 0021: Forward-Secret Ephemeral Secrets" class="linkLabel_WmDU">ADR 0021: Forward-Secret Ephemeral Secrets</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0022-keymanager-master-secrets"><span title="ADR 0022: Forward-Secret Master Secrets" class="linkLabel_WmDU">ADR 0022: Forward-Secret Master Secrets</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0023-keymanager-secret-sharing"><span title="ADR 0023: Secret Sharing Schemes (CHURP)" class="linkLabel_WmDU">ADR 0023: Secret Sharing Schemes (CHURP)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0024-off-chain-runtime-logic"><span title="ADR 0024: Runtime Off-chain Logic (ROFL)" class="linkLabel_WmDU">ADR 0024: Runtime Off-chain Logic (ROFL)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/adrs/0025-bundle_hot_loading"><span title="ADR 0025: Hot-loading of Runtime Bundles" class="linkLabel_WmDU">ADR 0025: Hot-loading of Runtime Bundles</span></a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>ADR 0003: Consensus/Runtime Token Transfer</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="component">Component<a href="#component" class="hash-link" aria-label="Direct link to Component" title="Direct link to Component" translate="no">​</a></h2>
<p>Oasis Core</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="changelog">Changelog<a href="#changelog" class="hash-link" aria-label="Direct link to Changelog" title="Direct link to Changelog" translate="no">​</a></h2>
<ul>
<li class="">2020-09-16: Beneficiary allowance, add message results</li>
<li class="">2020-09-08: Initial draft</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status" translate="no">​</a></h2>
<p>Accepted</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context" translate="no">​</a></h2>
<p>Currently each runtime can define its own token (or none at all) and there is no
mechanism that would support transfer of consensus layer tokens into a runtime
and back out.</p>
<p>Introducing such a mechanism would allow the consensus layer tokens to be used
inside runtimes for various functions. This ADR proposes such a mechanism.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision" translate="no">​</a></h2>
<p>On a high level, this proposal adds support for consensus/runtime token
transfers as follows:</p>
<ul>
<li class="">
<p><strong>Each staking account can set an allowance for beneficiaries.</strong> Each staking
account can set an allowance, a maximum amount a beneficiary can withdraw from
the given account. Beneficiaries are identified by their address. This is
similar to approve/transferFrom calls defined by the <a href="https://eips.ethereum.org/EIPS/eip-20" target="_blank" rel="noopener noreferrer" class="">ERC-20 Token Standard</a>.
Previously such functionality was already present but was removed in
<a href="https://github.com/oasisprotocol/oasis-core/issues/2021" target="_blank" rel="noopener noreferrer" class="">oasis-core#2021</a>.</p>
</li>
<li class="">
<p><strong>Each runtime itself has an account in the consensus layer.</strong> This account
contains the balance of tokens which are managed exclusively by the runtime
and do not belong to any specific regular account in the consensus layer.</p>
<p>It is not possible to transfer directly into a runtime account and doing so
may result in funds to be locked without a way to reclaim them.</p>
<p>The only way to perform any operations on runtime accounts is through the use
of messages emitted by the runtime during each round. These messages are
subject to discrepancy detection and instruct the consensus layer what to do.</p>
</li>
</ul>
<p>Combined, the two mechanisms enable account holders to set an allowance in the
benefit of runtimes so that the runtimes can withdraw up to the allowed amount
from the account holder&#x27;s address.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="addresses">Addresses<a href="#addresses" class="hash-link" aria-label="Direct link to Addresses" title="Direct link to Addresses" translate="no">​</a></h3>
<p>This proposal introduces the following new address context for the runtime
accounts:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">oasis-core/address: runtime</span><br></span></code></pre></div></div>
<p>Initial version for the address context is <code>0</code>. To derive the address, the
standard address derivation scheme is used, with the runtime&#x27;s 32-byte
identifier used as the <code>data</code> part.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="state">State<a href="#state" class="hash-link" aria-label="Direct link to State" title="Direct link to State" translate="no">​</a></h3>
<p>This proposal introduces/updates the following consensus state in the staking
module:</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="general-accounts">General Accounts<a href="#general-accounts" class="hash-link" aria-label="Direct link to General Accounts" title="Direct link to General Accounts" translate="no">​</a></h4>
<p>The general account data structure is modified to include an additional field
storing the allowances as follows:</p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type GeneralAccount struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... existing fields omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Allowances map[Address]quantity.Quantity `json:&quot;allowances,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="transaction-methods">Transaction Methods<a href="#transaction-methods" class="hash-link" aria-label="Direct link to Transaction Methods" title="Direct link to Transaction Methods" translate="no">​</a></h3>
<p>This proposal adds the following new transaction methods in the staking module:</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="allow">Allow<a href="#allow" class="hash-link" aria-label="Direct link to Allow" title="Direct link to Allow" translate="no">​</a></h4>
<p>Allow enables an account holder to set an allowance for a beneficiary.</p>
<p><strong>Method name:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">staking.Allow</span><br></span></code></pre></div></div>
<p><strong>Body:</strong></p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type Allow struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Beneficiary  Address           `json:&quot;beneficiary&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Negative     bool              `json:&quot;negative,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AmountChange quantity.Quantity `json:&quot;amount_change&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Fields:</strong></p>
<ul>
<li class=""><code>beneficiary</code> specifies the beneficiary account address.</li>
<li class=""><code>amount_change</code> specifies the absolute value of the amount of base units to
change the allowance for.</li>
<li class=""><code>negative</code> specifies whether the <code>amount_change</code> should be subtracted instead
of added.</li>
</ul>
<p>The transaction signer implicitly specifies the general account. Upon executing
the allow the following actions are performed:</p>
<ul>
<li class="">
<p>If either the <code>disable_transfers</code> staking consensus parameter is set to <code>true</code>
or the <code>max_allowances</code> staking consensus parameter is set to zero, the method
fails with <code>ErrForbidden</code>.</p>
</li>
<li class="">
<p>It is checked whether either the transaction signer address or the
<code>beneficiary</code> address are reserved. If any are reserved, the method fails with
<code>ErrForbidden</code>.</p>
</li>
<li class="">
<p>Address specified by <code>beneficiary</code> is compared with the transaction signer
address. If the addresses are the same, the method fails with
<code>ErrInvalidArgument</code>.</p>
</li>
<li class="">
<p>The account indicated by the signer is loaded.</p>
</li>
<li class="">
<p>If the allow would create a new allowance and the maximum number of allowances
for an account has been reached, the method fails with <code>ErrTooManyAllowances</code>.</p>
</li>
<li class="">
<p>The set of allowances is updated so that the allowance is updated as specified
by <code>amount_change</code>/<code>negative</code>. In case the change would cause the allowance to
be equal to zero or negative, the allowance is removed.</p>
</li>
<li class="">
<p>The account is saved.</p>
</li>
<li class="">
<p>The corresponding <code>AllowanceChangeEvent</code> is emitted with the following
structure:</p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type AllowanceChangeEvent struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Owner        Address           `json:&quot;owner&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Beneficiary  Address           `json:&quot;beneficiary&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Allowance    quantity.Quantity `json:&quot;allowance&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Negative     bool              `json:&quot;negative,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AmountChange quantity.Quantity `json:&quot;amount_change&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Where <code>allowance</code> contains the new total allowance, the <code>amount_change</code>
contains the absolute amount the allowance has changed for and <code>negative</code>
specifies whether the allowance has been reduced rather than increased. The
event is emitted even if the new allowance is zero.</p>
</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="withdraw">Withdraw<a href="#withdraw" class="hash-link" aria-label="Direct link to Withdraw" title="Direct link to Withdraw" translate="no">​</a></h4>
<p>Withdraw enables a beneficiary to withdraw from the given account.</p>
<p><strong>Method name:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">staking.Withdraw</span><br></span></code></pre></div></div>
<p><strong>Body:</strong></p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type Withdraw struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    From   Address           `json:&quot;from&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Amount quantity.Quantity `json:&quot;amount&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Fields:</strong></p>
<ul>
<li class=""><code>from</code> specifies the account address to withdraw from.</li>
<li class=""><code>amount</code> specifies the amount of base units to withdraw.</li>
</ul>
<p>The transaction signer implicitly specifies the destination general account.
Upon executing the withdrawal the following actions are performed:</p>
<ul>
<li class="">
<p>If either the <code>disable_transfers</code> staking consensus parameter is set to <code>true</code>
or the <code>max_allowances</code> staking consensus parameter is set to zero, the method
fails with <code>ErrForbidden</code>.</p>
</li>
<li class="">
<p>It is checked whether either the transaction signer address or the
<code>from</code> address are reserved. If any are reserved, the method fails with
<code>ErrForbidden</code>.</p>
</li>
<li class="">
<p>Address specified by <code>from</code> is compared with the transaction signer address.
If the addresses are the same, the method fails with <code>ErrInvalidArgument</code>.</p>
</li>
<li class="">
<p>The source account indicated by <code>from</code> is loaded.</p>
</li>
<li class="">
<p>The destination account indicated by the transaction signer is loaded.</p>
</li>
<li class="">
<p><code>amount</code> is deducted from the corresponding allowance in the source account.
If this would cause the allowance to go negative, the method fails with
<code>ErrForbidden</code>.</p>
</li>
<li class="">
<p><code>amount</code> is deducted from the source general account balance. If this would
cause the balance to go negative, the method fails with
<code>ErrInsufficientBalance</code>.</p>
</li>
<li class="">
<p><code>amount</code> is added to the destination general account balance.</p>
</li>
<li class="">
<p>Both source and destination accounts are saved.</p>
</li>
<li class="">
<p>The corresponding <code>TransferEvent</code> is emitted.</p>
</li>
<li class="">
<p>The corresponding <code>AllowanceChangeEvent</code> is emitted with the updated
allowance.</p>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="queries">Queries<a href="#queries" class="hash-link" aria-label="Direct link to Queries" title="Direct link to Queries" translate="no">​</a></h3>
<p>This proposal adds the following new query methods in the staking module by
updating the <code>staking.Backend</code> interface as follows:</p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type Backend interface {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... existing methods omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Allowance looks up the allowance for the given owner/beneficiary combination.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Allowance(ctx context.Context, query *AllowanceQuery) (*quantity.Quantity, error)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// AllowanceQuery is an allowance query.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type AllowanceQuery struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Height      int64   `json:&quot;height&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Owner       Address `json:&quot;owner&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Beneficiary Address `json:&quot;beneficiary&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="messages">Messages<a href="#messages" class="hash-link" aria-label="Direct link to Messages" title="Direct link to Messages" translate="no">​</a></h3>
<p>Since this is the first proposal that introduces a new runtime message type that
can be emitted from a runtime during a round, it also defines some general
properties of runtime messages and the dispatch mechanism:</p>
<ul>
<li class="">
<p>Each message has an associated gas cost that needs to be paid by the
submitter (e.g. as part of the <code>roothash.ExecutorCommit</code> method call). The gas
cost is split among the committee members.</p>
</li>
<li class="">
<p>There is a maximum number of messages that can be emitted by a runtime during
a given round. The limit is defined both globally (e.g. a roothash consensus
parameter) and per-runtime (which needs to be equal to or lower than the
global limit).</p>
</li>
<li class="">
<p>Messages are serialized using a sum type describing all possible messages,
where each message type is assigned a <em>field name</em>:</p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type Message struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Message1 *Message1 `json:&quot;message1,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Message2 *Message2 `json:&quot;message2,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>All messages are versioned by embeding the <code>cbor.Versioned</code> structure which
provides a single <code>uint16</code> field <code>v</code>.</p>
</li>
<li class="">
<p>A change is made to how messages are included in commitments, to reduce the
size of submitted transactions.</p>
<p>The <code>ComputeResultsHeader</code> is changed so that the <code>Messages</code> field is replaced
with a <code>MessagesHash</code> field containing a hash of the CBOR-encoded messages
emitted by the runtime.</p>
<p>At the same time <code>ComputeBody</code> is changed to include an additional field
<code>Messages</code> as follows:</p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type ComputeBody struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... existing fields omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Messages []*block.Message `json:&quot;messages,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The <code>Messages</code> field must only be populated in the commitment by the
transaction scheduler and must match the <code>MessagesHash</code>.</p>
</li>
<li class="">
<p>If any of the included messages is deemed <em>malformed</em>, the round fails and the
runtime state is not updated.</p>
</li>
<li class="">
<p>In order to support messages that fail to execute, a new roothash event is
emitted for each executed message:</p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type MessageEvent struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Index  uint32 `json:&quot;index,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Module string `json:&quot;module,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Code   uint32 `json:&quot;code,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Where the <code>index</code> specifies the index of the executed message and the <code>module</code>
and <code>code</code> specify the module and error code accoording to Oasis Core error
encoding convention (note that the usual human readable message field is not
included).</p>
</li>
</ul>
<p>This proposal introduces the following runtime messages:</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="staking-method-call">Staking Method Call<a href="#staking-method-call" class="hash-link" aria-label="Direct link to Staking Method Call" title="Direct link to Staking Method Call" translate="no">​</a></h4>
<p>The staking method call message enables a runtime to call one of the supported
staking module methods.</p>
<p><strong>Field name:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">staking</span><br></span></code></pre></div></div>
<p><strong>Body:</strong></p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type StakingMessage struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cbor.Versioned</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Transfer *staking.Transfer `json:&quot;transfer,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Withdraw *staking.Withdraw `json:&quot;withdraw,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Fields:</strong></p>
<ul>
<li class=""><code>v</code> must be set to <code>0</code>.</li>
<li class=""><code>transfer</code> indicates that the <code>staking.Transfer</code> method should be executed.</li>
<li class=""><code>withdraw</code> indicates that the <code>staking.Withdraw</code> method should be executed.</li>
</ul>
<p>Exactly one of the supported method fields needs to be non-nil, otherwise the
message is considered malformed.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="consensus-parameters">Consensus Parameters<a href="#consensus-parameters" class="hash-link" aria-label="Direct link to Consensus Parameters" title="Direct link to Consensus Parameters" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="staking">Staking<a href="#staking" class="hash-link" aria-label="Direct link to Staking" title="Direct link to Staking" translate="no">​</a></h4>
<p>This proposal introduces the following new consensus parameters in the staking
module:</p>
<ul>
<li class=""><code>max_allowances</code> (uint32) specifies the maximum number of allowances an
account can store. Zero means that allowance functionality is disabled.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="roothash">Roothash<a href="#roothash" class="hash-link" aria-label="Direct link to Roothash" title="Direct link to Roothash" translate="no">​</a></h4>
<p>This proposal introduces the following new consensus parameters in the roothash
module:</p>
<ul>
<li class=""><code>max_runtime_messages</code> (uint32) specifies the global limit on the number of
messages that can be emitted in each round by the runtime. The default value
of <code>0</code> disables the use of runtime messages.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="runtime-host-protocol">Runtime Host Protocol<a href="#runtime-host-protocol" class="hash-link" aria-label="Direct link to Runtime Host Protocol" title="Direct link to Runtime Host Protocol" translate="no">​</a></h3>
<p>This proposal modifies the runtime host protocol as follows:</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="host-to-runtime-initialization">Host to Runtime: Initialization<a href="#host-to-runtime-initialization" class="hash-link" aria-label="Direct link to Host to Runtime: Initialization" title="Direct link to Host to Runtime: Initialization" translate="no">​</a></h4>
<p>The existing <code>RuntimeInfoRequest</code> message body is updated to contain a field
denoting the consensus backend used by the host and its consensus protocol
version as follows:</p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type RuntimeInfoRequest struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConsensusBackend         string `json:&quot;consensus_backend&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConsensusProtocolVersion uint64 `json:&quot;consensus_protocol_version&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... existing fields omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>This information can be used by the runtime to ensure that it supports the
consensus layer used by the host. In case the backend and/or protocol version is
not supported, the runtime should return an error and terminate. In case the
runtime does not interact with the consensus layer it may ignore the consensus
layer information.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="host-to-runtime-transaction-batch-dispatch">Host to Runtime: Transaction Batch Dispatch<a href="#host-to-runtime-transaction-batch-dispatch" class="hash-link" aria-label="Direct link to Host to Runtime: Transaction Batch Dispatch" title="Direct link to Host to Runtime: Transaction Batch Dispatch" translate="no">​</a></h4>
<p>The existing <code>RuntimeExecuteTxBatchRequest</code> and <code>RuntimeCheckTxBatchRequest</code>
message bodies are updated to include the consensus layer light block at the
last finalized round height (specified in <code>.Block.Header.Round</code>) and the list of
<code>MessageEvent</code>s emitted while processing the runtime messages emitted in the
previous round as follows:</p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type RuntimeExecuteTxBatchRequest struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ConsensusBlock is the consensus light block at the last finalized round</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // height (e.g., corresponding to .Block.Header.Round).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConsensusBlock consensus.LightBlock `json:&quot;consensus_block&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // MessageResults are the results of executing messages emitted by the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // runtime in the previous round (sorted by .Index).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MessageResults []roothash.MessageEvent `json:&quot;message_results,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... existing fields omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type RuntimeCheckTxBatchRequest struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ConsensusBlock is the consensus light block at the last finalized round</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // height (e.g., corresponding to .Block.Header.Round).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConsensusBlock consensus.LightBlock `json:&quot;consensus_block&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... existing fields omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The information from the light block can be used to access consensus layer
state.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="runtime-to-host-read-only-storage-access">Runtime to Host: Read-only Storage Access<a href="#runtime-to-host-read-only-storage-access" class="hash-link" aria-label="Direct link to Runtime to Host: Read-only Storage Access" title="Direct link to Runtime to Host: Read-only Storage Access" translate="no">​</a></h4>
<p>The existing <code>HostStorageSyncRequest</code> message body is updated to include an
endpoint identifier as follows:</p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type HostStorageSyncRequest struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Endpoint is the storage endpoint to which this request should be routed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Endpoint string `json:&quot;endpoint,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... existing fields omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The newly introduced <code>endpoint</code> field can take the following values:</p>
<ul>
<li class="">
<p><code>runtime</code> (or empty string) denotes the runtime state endpoint. The empty
value is allowed for backwards compatibility as this was the only endpoint
available before this proposal.</p>
</li>
<li class="">
<p><code>consensus</code> denotes the consensus state endpoint, providing access to
consensus state.</p>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="rust-runtime-support-library">Rust Runtime Support Library<a href="#rust-runtime-support-library" class="hash-link" aria-label="Direct link to Rust Runtime Support Library" title="Direct link to Rust Runtime Support Library" translate="no">​</a></h3>
<p>The Rust runtime support library (<code>oasis-core-runtime</code>) must be updated to
support the updated message structures. Additionally, there needs to be basic
support for interpreting the data from the Tendermint consensus layer backend:</p>
<ul>
<li class="">
<p>Decoding light blocks.</p>
</li>
<li class="">
<p>Decoding staking-related state structures.</p>
</li>
</ul>
<p>The Tendermint-specific functionality should be part of a separate crate.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="expected-userconsensusruntime-flow">Expected User/Consensus/Runtime Flow<a href="#expected-userconsensusruntime-flow" class="hash-link" aria-label="Direct link to Expected User/Consensus/Runtime Flow" title="Direct link to Expected User/Consensus/Runtime Flow" translate="no">​</a></h3>
<p><strong>Scenario:</strong></p>
<p>Account holder has 100 tokens in her account in the consensus layer staking
ledger and would like to spend 50 tokens to execute an action in runtime X.</p>
<p><strong>Flow:</strong></p>
<ul>
<li class="">
<p>Account holder sets an allowance of 50 tokens for runtime X by submitting an
allow transaction to the consensus layer.</p>
</li>
<li class="">
<p>Account holder submits a runtime transaction that performs some action costing
50 tokens.</p>
</li>
<li class="">
<p>Account holder&#x27;s runtime transaction is executed in runtime X round R:</p>
<ul>
<li class="">
<p>Runtime X emits a message to transfer 50 tokens from the user&#x27;s account to
the runtime&#x27;s own account.</p>
<p><em>As an optimization runtime X can verify current consensus layer state and
reject the transaction early to prevent paying for needless consensus layer
message processing.</em></p>
</li>
<li class="">
<p>Runtime X updates its state to indicate a pending transfer of 50 tokens from
the user. It uses the index of the emitted message to be able to match the
message execution result once it arrives.</p>
</li>
<li class="">
<p>Runtime X submits commitments to the consensus layer.</p>
</li>
</ul>
</li>
<li class="">
<p>When finalizing round R for runtime X, the consensus layer transfers 50 tokens
from the account holder&#x27;s account to the runtime X account.</p>
</li>
<li class="">
<p>Corresponding message result event is emitted, indicating success.</p>
</li>
<li class="">
<p>When runtime X processes round R+1, the runtime receives the set of emitted
message result events.</p>
</li>
<li class="">
<p>Runtime X processes message result events, using the index field to match the
corresponding pending action and executes whatever action it queued.</p>
<ul>
<li class="">In case the message result event would indicate failure, the pending action
can be pruned.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="positive">Positive<a href="#positive" class="hash-link" aria-label="Direct link to Positive" title="Direct link to Positive" translate="no">​</a></h3>
<ul>
<li class="">
<p>Consensus layer tokens can be transferred into and out of runtimes, enabling
more use cases.</p>
</li>
<li class="">
<p>Any tokens must be explicitly made available to the runtime which limits the
damage from badly written or malicious runtimes.</p>
</li>
<li class="">
<p>Account holders can change the allowance at any time.</p>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="negative">Negative<a href="#negative" class="hash-link" aria-label="Direct link to Negative" title="Direct link to Negative" translate="no">​</a></h3>
<ul>
<li class="">
<p>A badly written or malicious runtime could steal the tokens explicitly
deposited into the runtime. This includes any actions by the runtime owner
which would modify the runtime&#x27;s security parameters.</p>
</li>
<li class="">
<p>A badly written, malicious or forever suspended runtime can lock tokens in
the runtime account forever. This could be mitigated via an unspecified
consensus layer governance mechanism.</p>
</li>
<li class="">
<p>Account holders may mistakenly transfer tokens directly into a runtime account
which may cause such tokens to be locked forever.</p>
</li>
<li class="">
<p>Account holders may change the allowance or reduce their account balance right
before the runtime round is finalized, causing the emitted messages to fail
while the runtime still needs to pay for gas to execute the messages.</p>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="neutral">Neutral<a href="#neutral" class="hash-link" aria-label="Direct link to Neutral" title="Direct link to Neutral" translate="no">​</a></h3>
<ul>
<li class="">The runtime must handle all message results in the next round as otherwise it
cannot easily get past messages.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References" translate="no">​</a></h2>
<ul>
<li class=""><a href="https://eips.ethereum.org/EIPS/eip-20" target="_blank" rel="noopener noreferrer" class="">ERC-20 Token Standard</a></li>
<li class=""><a href="https://github.com/oasisprotocol/oasis-core/issues/2021" target="_blank" rel="noopener noreferrer" class="">oasis-core#2021</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/oasisprotocol/adrs/edit/main/0003-consensus-runtime-token-transfer.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-08-04T08:13:58.000Z" itemprop="dateModified">Aug 4, 2025</time></b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/adrs/0002-go-modules-compatible-git-tags"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">ADR 0002: Go Modules Compatible Git Tags</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/adrs/0004-runtime-governance"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ADR 0004: Runtime Governance</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#component" class="table-of-contents__link toc-highlight">Component</a></li><li><a href="#changelog" class="table-of-contents__link toc-highlight">Changelog</a></li><li><a href="#status" class="table-of-contents__link toc-highlight">Status</a></li><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a></li><li><a href="#decision" class="table-of-contents__link toc-highlight">Decision</a><ul><li><a href="#addresses" class="table-of-contents__link toc-highlight">Addresses</a></li><li><a href="#state" class="table-of-contents__link toc-highlight">State</a></li><li><a href="#transaction-methods" class="table-of-contents__link toc-highlight">Transaction Methods</a></li><li><a href="#queries" class="table-of-contents__link toc-highlight">Queries</a></li><li><a href="#messages" class="table-of-contents__link toc-highlight">Messages</a></li><li><a href="#consensus-parameters" class="table-of-contents__link toc-highlight">Consensus Parameters</a></li><li><a href="#runtime-host-protocol" class="table-of-contents__link toc-highlight">Runtime Host Protocol</a></li><li><a href="#rust-runtime-support-library" class="table-of-contents__link toc-highlight">Rust Runtime Support Library</a></li><li><a href="#expected-userconsensusruntime-flow" class="table-of-contents__link toc-highlight">Expected User/Consensus/Runtime Flow</a></li></ul></li><li><a href="#consequences" class="table-of-contents__link toc-highlight">Consequences</a><ul><li><a href="#positive" class="table-of-contents__link toc-highlight">Positive</a></li><li><a href="#negative" class="table-of-contents__link toc-highlight">Negative</a></li><li><a href="#neutral" class="table-of-contents__link toc-highlight">Neutral</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Tools</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://explorer.oasis.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Explorer</a></li><li class="footer__item"><a href="https://wallet.oasis.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Wallet</a></li><li class="footer__item"><a href="https://github.com/oasisprotocol/cli" target="_blank" rel="noopener noreferrer" class="footer__link-item">CLI</a></li><li class="footer__item"><a href="https://status.oasis.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Status</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Build</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://faucet.testnet.oasis.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Testnet Faucet</a></li><li class="footer__item"><a href="https://playground.oasis.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Playground</a></li><li class="footer__item"><a href="https://api.docs.oasis.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">API</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Node</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/node/network/mainnet">Mainnet</a></li><li class="footer__item"><a class="footer__link-item" href="/node/network/testnet">Testnet</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://oasis.io/discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://t.me/oasisprotocolcommunity" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram</a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UC35UFPcZ2F1wjPxhPrSsESQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://github.com/oasisprotocol" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
<p xmlns:cc="http://creativecommons.org/ns#">Copyright © 2025
by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="https://oasis.net">
Oasis Protocol Foundation</a>. We <a href="https://oasisprotocol.org/privacy-policy" target="_blank" rel="noopener noreferrer">respect your privacy</a>.
Unless otherwise specified, all text and images on this website are licensed
under <a href="http://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">
CC BY 4.0<img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="/img/cc.svg"><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="/img/by.svg"></a>.
This does not include the Oasis software and the code examples, both of which are
licensed under <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">
Apache 2.0</a>. Built with &#x2665; and Docusaurus.</p></div></div></div></footer><!--$--><!--/$--></div>
</body>
</html>