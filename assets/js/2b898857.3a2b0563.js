"use strict";(globalThis.webpackChunkdocs_oasis_io=globalThis.webpackChunkdocs_oasis_io||[]).push([[3546],{28453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>a});var t=s(96540);const r={},o=t.createContext(r);function i(e){const n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(o.Provider,{value:n},e.children)}},94277:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"build/use-cases/key-generation","title":"Cross-Chain Key Generation (EVM / Base)","description":"Generate an Ethereum-compatible key inside ROFL via appd and use it to sign and send transactions on Base.","source":"@site/docs/build/use-cases/key-generation.mdx","sourceDirName":"build/use-cases","slug":"/build/use-cases/key-generation","permalink":"/build/use-cases/key-generation","draft":false,"unlisted":false,"editUrl":"https://github.com/oasisprotocol/docs/edit/main/docs/build/use-cases/key-generation.mdx","tags":[{"inline":true,"label":"ROFL","permalink":"/tags/rofl"},{"inline":true,"label":"appd","permalink":"/tags/appd"},{"inline":true,"label":"KMS","permalink":"/tags/kms"},{"inline":true,"label":"EVM","permalink":"/tags/evm"}],"version":"current","lastUpdatedAt":1769514538000,"frontMatter":{"sidebar_label":"Cross-Chain Key Generation","description":"Generate an Ethereum-compatible key inside ROFL via appd and use it to sign and send transactions on Base.","tags":["ROFL","appd","KMS","EVM"],"sidebar_custom_props":{"tags":["ROFL","appd","KMS","EVM"]}},"sidebar":"developers","previous":{"title":"Use cases","permalink":"/build/use-cases"},"next":{"title":"Trustless AI Agent","permalink":"/build/use-cases/trustless-agent"}}');var r=s(74848),o=s(28453);const i={sidebar_label:"Cross-Chain Key Generation",description:"Generate an Ethereum-compatible key inside ROFL via appd and use it to sign and send transactions on Base.",tags:["ROFL","appd","KMS","EVM"],sidebar_custom_props:{tags:["ROFL","appd","KMS","EVM"]}},a="Cross-Chain Key Generation (EVM / Base)",c={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Init App",id:"init-app",level:2},{value:"Create App",id:"create-app",level:2},{value:"Init a Hardhat (TypeScript) project",id:"init-a-hardhat-typescript-project",level:2},{value:"App structure",id:"app-structure",level:2},{value:"<code>src/appd.ts</code> \u2014 thin wrapper over the SDK",id:"srcappdts--thin-wrapper-over-the-sdk",level:3},{value:"<code>src/evm.ts</code> \u2014 ethers helpers",id:"srcevmts--ethers-helpers",level:3},{value:"<code>src/keys.ts</code> \u2014 tiny helpers",id:"srckeysts--tiny-helpers",level:3},{value:"<code>src/scripts/smoke-test.ts</code> \u2014 single end\u2011to\u2011end flow",id:"srcscriptssmoke-testts--single-endtoend-flow",level:3},{value:"<code>contracts/Counter.sol</code> \u2014 minimal sample",id:"contractscountersol--minimal-sample",level:3},{value:"<code>src/scripts/deploy-contract.ts</code> \u2014 generic deployer",id:"srcscriptsdeploy-contractts--generic-deployer",level:3},{value:"Hardhat (contracts only)",id:"hardhat-contracts-only",level:2},{value:"Containerize",id:"containerize",level:2},{value:"Build the image",id:"build-the-image",level:2},{value:"Build ROFL bundle",id:"build-rofl-bundle",level:2},{value:"Deploy",id:"deploy",level:2},{value:"End\u2011to\u2011end (Base Sepolia)",id:"endtoend-base-sepolia",level:2},{value:"Security &amp; notes",id:"security--notes",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components},{Details:s}=n;return s||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"cross-chain-key-generation-evm--base",children:"Cross-Chain Key Generation (EVM / Base)"})}),"\n",(0,r.jsxs)(n.p,{children:["This chapter shows how to build a tiny TypeScript app that ",(0,r.jsx)(n.strong,{children:"generates a\nsecp256k1 key inside ROFL"})," using the\n",(0,r.jsxs)(n.strong,{children:[(0,r.jsx)(n.code,{children:"@oasisprotocol/rofl-client"})," TypeScript SDK"]})," (which talks to the\n",(0,r.jsx)(n.a,{href:"/build/rofl/features/appd",children:"appd REST API"})," under the hood), derives an ",(0,r.jsx)(n.strong,{children:"EVM address"}),", ",(0,r.jsx)(n.strong,{children:"signs"}),"\nmessages, ",(0,r.jsx)(n.strong,{children:"deploys a contract"}),", and ",(0,r.jsx)(n.strong,{children:"sends"})," EIP-1559 transactions on\n",(0,r.jsx)(n.strong,{children:"Base Sepolia"}),". We use a simple ",(0,r.jsx)(n.strong,{children:"smoke test"})," that prints to logs."]}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsx)(n.p,{children:"This guide requires:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Node.js 20+"})," and ",(0,r.jsx)(n.strong,{children:"Docker"})," (or Podman)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Oasis CLI"})," and at least ",(0,r.jsx)(n.strong,{children:"120 TEST"})," tokens in your wallet\n(use ",(0,r.jsx)(n.a,{href:"https://faucet.testnet.oasis.io",children:"Oasis Testnet faucet"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Some Base Sepolia test ETH (use ",(0,r.jsx)(n.a,{href:"https://docs.base.org/base-chain/tools/network-faucets",children:"Base Sepolia faucet"}),") to test sending ETH."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Check ",(0,r.jsx)(n.a,{href:"../rofl/quickstart#prerequisites",children:"Quickstart Prerequisites"})," for setup details."]}),"\n",(0,r.jsx)(n.h2,{id:"init-app",children:"Init App"}),"\n",(0,r.jsx)(n.p,{children:"Initialize a new app using the [Oasis CLI]:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oasis rofl init rofl-keygen\ncd rofl-keygen\n"})}),"\n",(0,r.jsx)(n.h2,{id:"create-app",children:"Create App"}),"\n",(0,r.jsx)(n.p,{children:"Create the app on Testnet (100 TEST deposit):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oasis rofl create --network testnet\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The CLI prints the ",(0,r.jsx)(n.strong,{children:"App ID"})," (e.g., ",(0,r.jsx)(n.code,{children:"rofl1..."}),")."]}),"\n",(0,r.jsx)(n.h2,{id:"init-a-hardhat-typescript-project",children:"Init a Hardhat (TypeScript) project"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"npx hardhat init\n"})}),"\n",(0,r.jsxs)(n.p,{children:["When prompted, ",(0,r.jsx)(n.strong,{children:"choose TypeScript"})," and accept the defaults."]}),"\n",(0,r.jsx)(n.p,{children:"Now add the small runtime deps we use outside of Hardhat:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"npm i @oasisprotocol/rofl-client ethers dotenv @types/node\nnpm i -D tsx\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Using Hardhat\u2019s TypeScript template, it already created a ",(0,r.jsx)(n.code,{children:"tsconfig.json"}),".\nAdd the following so our app code compiles to ",(0,r.jsx)(n.code,{children:"dist/"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'// tsconfig.json\n{\n  "compilerOptions": {\n    "rootDir": "./src",\n    "outDir": "./dist"\n  },\n  "include": ["src"]\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"app-structure",children:"App structure"}),"\n",(0,r.jsx)(n.p,{children:"We'll add a few small TS files and one Solidity contract:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"src/\n\u251c\u2500\u2500 appd.ts               # thin wrapper over @oasisprotocol/rofl-client\n\u251c\u2500\u2500 evm.ts                # ethers helpers (provider, wallet, tx, deploy)\n\u251c\u2500\u2500 keys.ts               # tiny helpers (checksum)\n\u2514\u2500\u2500 scripts/\n    \u251c\u2500\u2500 deploy-contract.ts  # generic deploy script for compiled artifacts\n    \u2514\u2500\u2500 smoke-test.ts       # end-to-end demo (logs)\ncontracts/\n\u2514\u2500\u2500 Counter.sol           # sample contract\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"srcappdts--thin-wrapper-over-the-sdk",children:[(0,r.jsx)(n.code,{children:"src/appd.ts"})," \u2014 thin wrapper over the SDK"]}),"\n",(0,r.jsxs)(n.p,{children:["Use the official client to talk to ",(0,r.jsx)(n.code,{children:"appd"})," (UNIX socket) and keep an explicit\n",(0,r.jsx)(n.strong,{children:"local\u2011dev fallback"})," when running outside ROFL."]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"src/appd.ts"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {existsSync} from 'node:fs';\nimport {\n  RoflClient,\n  KeyKind,\n  ROFL_SOCKET_PATH\n} from '@oasisprotocol/rofl-client';\n\nconst client = new RoflClient(); // UDS: /run/rofl-appd.sock\n\nexport async function getAppId(): Promise<string> {\n  return client.getAppId();\n}\n\n/**\n * Generates (or deterministically re-derives) a secp256k1 key inside ROFL and\n * returns it as a 0x-prefixed hex string (for ethers.js Wallet).\n *\n * Local development ONLY (outside ROFL): If the socket is missing and you set\n * ALLOW_LOCAL_DEV=true and LOCAL_DEV_SK=0x<64-hex>, that value is used.\n */\nexport async function getEvmSecretKey(keyId: string): Promise<string> {\n  if (existsSync(ROFL_SOCKET_PATH)) {\n    const hex = await client.generateKey(keyId, KeyKind.SECP256K1);\n    return hex.startsWith('0x') ? hex : `0x${hex}`;\n  }\n  const allow = process.env.ALLOW_LOCAL_DEV === 'true';\n  const pk = process.env.LOCAL_DEV_SK;\n  if (allow && pk && /^0x[0-9a-fA-F]{64}$/.test(pk)) return pk;\n  throw new Error(\n    'rofl-appd socket not found and no LOCAL_DEV_SK provided (dev only).'\n  );\n}\n"})})]}),"\n",(0,r.jsxs)(n.h3,{id:"srcevmts--ethers-helpers",children:[(0,r.jsx)(n.code,{children:"src/evm.ts"})," \u2014 ethers helpers"]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"src/evm.ts"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:'import {\n  JsonRpcProvider,\n  Wallet,\n  parseEther,\n  type TransactionReceipt,\n  ContractFactory\n} from "ethers";\n\nexport function makeProvider(rpcUrl: string, chainId: number) {\n  return new JsonRpcProvider(rpcUrl, chainId);\n}\n\nexport function connectWallet(\n  skHex: string,\n  rpcUrl: string,\n  chainId: number\n): Wallet {\n  const w = new Wallet(skHex);\n  return w.connect(makeProvider(rpcUrl, chainId));\n}\n\nexport async function signPersonalMessage(wallet: Wallet, msg: string) {\n  return wallet.signMessage(msg);\n}\n\nexport async function sendEth(\n  wallet: Wallet,\n  to: string,\n  amountEth: string\n): Promise<TransactionReceipt> {\n  const tx = await wallet.sendTransaction({\n    to,\n    value: parseEther(amountEth)\n  });\n  const receipt = await tx.wait();\n  if (receipt == null) {\n    throw new Error("Transaction dropped or replaced before confirmation");\n  }\n  return receipt;\n}\n\nexport async function deployContract(\n  wallet: Wallet,\n  abi: any[],\n  bytecode: string,\n  args: unknown[] = []\n): Promise<{ address: string; receipt: TransactionReceipt }> {\n  const factory = new ContractFactory(abi, bytecode, wallet);\n  const contract = await factory.deploy(...args);\n  const deployTx = contract.deploymentTransaction();\n  const receipt = await deployTx?.wait();\n  await contract.waitForDeployment();\n  if (!receipt) {\n    throw new Error("Deployment TX not mined");\n  }\n  return { address: contract.target as string, receipt };\n}\n'})})]}),"\n",(0,r.jsxs)(n.h3,{id:"srckeysts--tiny-helpers",children:[(0,r.jsx)(n.code,{children:"src/keys.ts"})," \u2014 tiny helpers"]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"src/keys.ts"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:'import { Wallet, getAddress } from "ethers";\n\nexport function secretKeyToWallet(skHex: string): Wallet {\n  return new Wallet(skHex);\n}\n\nexport function checksumAddress(addr: string): string {\n  return getAddress(addr);\n}\n'})})]}),"\n",(0,r.jsxs)(n.h3,{id:"srcscriptssmoke-testts--single-endtoend-flow",children:[(0,r.jsx)(n.code,{children:"src/scripts/smoke-test.ts"})," \u2014 single end\u2011to\u2011end flow"]}),"\n",(0,r.jsx)(n.p,{children:"This script prints the App ID (inside ROFL), address, a signed message,\nwaits for funding, and deploys the counter contract."}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"src/scripts/smoke-test.ts"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:'import "dotenv/config";\nimport { readFileSync } from "node:fs";\nimport { join } from "node:path";\nimport { getAppId, getEvmSecretKey } from "../appd.js";\nimport { secretKeyToWallet, checksumAddress } from "../keys.js";\nimport { makeProvider, signPersonalMessage, sendEth, deployContract } from "../evm.js";\nimport { formatEther, JsonRpcProvider } from "ethers";\n\nconst RPC_URL = process.env.BASE_RPC_URL ?? "https://sepolia.base.org";\nconst CHAIN_ID = Number(process.env.BASE_CHAIN_ID ?? "84532");\nconst KEY_ID = process.env.KEY_ID ?? "evm:base:sepolia";\n\nfunction sleep(ms: number): Promise<void> {\n  return new Promise((r) => setTimeout(r, ms));\n}\n\nasync function waitForFunding(\n  provider: JsonRpcProvider,\n  addr: string,\n  minWei: bigint = 1n,\n  timeoutMs = 15 * 60 * 1000,\n  pollMs = 5_000\n): Promise<bigint> {\n  const start = Date.now();\n  while (Date.now() - start < timeoutMs) {\n    const bal = await provider.getBalance(addr);\n    if (bal >= minWei) return bal;\n    console.log(`Waiting for funding... current balance=${formatEther(bal)} ETH`);\n    await sleep(pollMs);\n  }\n  throw new Error("Timed out waiting for funding.");\n}\n\nasync function main() {\n  const appId = await getAppId().catch(() => null);\n  console.log(`ROFL App ID: ${appId ?? "(unavailable outside ROFL)"}`);\n\n  const sk = await getEvmSecretKey(KEY_ID);\n  // NOTE: This demo trusts the configured RPC provider. For production, prefer a\n  // light client (for example, Helios) so you can verify remote chain state.\n  const wallet = secretKeyToWallet(sk).connect(makeProvider(RPC_URL, CHAIN_ID));\n  const addr = checksumAddress(await wallet.getAddress());\n  console.log(`EVM address (Base Sepolia): ${addr}`);\n\n  const msg = "hello from rofl";\n  const sig = await signPersonalMessage(wallet, msg);\n  console.log(`Signed message: "${msg}"`);\n  console.log(`Signature: ${sig}`);\n\n  const provider = wallet.provider as JsonRpcProvider;\n\n  let bal = await provider.getBalance(addr);\n  if (bal === 0n) {\n    console.log("Please fund the above address with Base Sepolia ETH to continue.");\n    bal = await waitForFunding(provider, addr);\n  }\n  console.log(`Balance detected: ${formatEther(bal)} ETH`);\n\n  const artifactPath = join(process.cwd(), "artifacts", "contracts", "Counter.sol", "Counter.json");\n  const artifact = JSON.parse(readFileSync(artifactPath, "utf8"));\n  if (!artifact?.abi || !artifact?.bytecode) {\n    throw new Error("Counter artifact missing abi/bytecode");\n  }\n  const { address: contractAddress, receipt: deployRcpt } =\n    await deployContract(wallet, artifact.abi, artifact.bytecode, []);\n  console.log(`Deployed Counter at ${contractAddress} (tx=${deployRcpt.hash})`);\n\n  console.log("Smoke test completed successfully!");\n}\n\nmain().catch((e) => {\n  console.error(e);\n  process.exit(1);\n});\n'})})]}),"\n",(0,r.jsxs)(n.h3,{id:"contractscountersol--minimal-sample",children:[(0,r.jsx)(n.code,{children:"contracts/Counter.sol"})," \u2014 minimal sample"]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"contracts/Counter.sol"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:"// SPDX-License-Identifier: MIT\npragma solidity ^0.8.24;\n\ncontract Counter {\n    uint256 private _value;\n    event Incremented(uint256 v);\n    event Set(uint256 v);\n\n    function current() external view returns (uint256) { return _value; }\n    function inc() external { unchecked { _value += 1; } emit Incremented(_value); }\n    function set(uint256 v) external { _value = v; emit Set(v); }\n}\n"})})]}),"\n",(0,r.jsxs)(n.h3,{id:"srcscriptsdeploy-contractts--generic-deployer",children:[(0,r.jsx)(n.code,{children:"src/scripts/deploy-contract.ts"})," \u2014 generic deployer"]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"src/scripts/deploy-contract.ts"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:'import "dotenv/config";\nimport { readFileSync } from "node:fs";\nimport { getEvmSecretKey } from "../appd.js";\nimport { secretKeyToWallet } from "../keys.js";\nimport { makeProvider, deployContract } from "../evm.js";\n\nconst KEY_ID = process.env.KEY_ID ?? "evm:base:sepolia";\nconst RPC_URL = process.env.BASE_RPC_URL ?? "https://sepolia.base.org";\nconst CHAIN_ID = Number(process.env.BASE_CHAIN_ID ?? "84532");\n\n/**\n * Usage:\n *   npm run deploy-contract -- ./artifacts/MyContract.json \'[arg0, arg1]\'\n * The artifact must contain { abi, bytecode }.\n */\nasync function main() {\n  const [artifactPath, ctorJson = "[]"] = process.argv.slice(2);\n  if (!artifactPath) {\n    console.error("Usage: npm run deploy-contract -- <artifact.json> \'[constructorArgsJson]\'");\n    process.exit(2);\n  }\n\n  const artifactRaw = readFileSync(artifactPath, "utf8");\n  const artifact = JSON.parse(artifactRaw);\n  const { abi, bytecode } = artifact ?? {};\n  if (!abi || !bytecode) {\n    throw new Error("Artifact must contain { abi, bytecode }");\n  }\n\n  let args: unknown[];\n  try {\n    args = JSON.parse(ctorJson);\n    if (!Array.isArray(args)) throw new Error("constructor args must be a JSON array");\n  } catch (e) {\n    throw new Error(`Failed to parse constructor args JSON: ${String(e)}`);\n  }\n\n  const sk = await getEvmSecretKey(KEY_ID);\n  // NOTE: This demo trusts the configured RPC provider. For production, prefer a\n  // light client (for example, Helios) so you can verify remote chain state.\n  const wallet = secretKeyToWallet(sk).connect(makeProvider(RPC_URL, CHAIN_ID));\n  const { address, receipt } = await deployContract(wallet, abi, bytecode, args);\n\n  console.log(JSON.stringify({ contractAddress: address, txHash: receipt.hash, status: receipt.status }, null, 2));\n}\n\nmain().catch((e) => {\n  console.error(e);\n  process.exit(1);\n});\n'})})]}),"\n",(0,r.jsx)(n.h2,{id:"hardhat-contracts-only",children:"Hardhat (contracts only)"}),"\n",(0,r.jsxs)(n.p,{children:["Minimal config to compile ",(0,r.jsx)(n.code,{children:"Counter.sol"}),":"]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"hardhat.config.ts"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:'import type { HardhatUserConfig } from "hardhat/config";\n\nconst config: HardhatUserConfig = {\n  solidity: {\n    version: "0.8.24",\n    settings: {\n      optimizer: { enabled: true, runs: 200 }\n    }\n  },\n  paths: {\n    sources: "./contracts",\n    artifacts: "./artifacts",\n    cache: "./cache"\n  }\n};\n\nexport default config;\n'})})]}),"\n",(0,r.jsxs)(n.p,{children:["Compile locally (optional). Delete the existing ",(0,r.jsx)(n.code,{children:"contracts/Lock.sol"})," file or\nupdate it to Solidity version ",(0,r.jsx)(n.code,{children:"0.8.24"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"npx hardhat compile\n"})}),"\n",(0,r.jsx)(n.h2,{id:"containerize",children:"Containerize"}),"\n",(0,r.jsxs)(n.p,{children:["Add a Dockerfile that builds TS and compiles the contract, runs the\n",(0,r.jsx)(n.strong,{children:"smoke test"})," once, then idles so you can inspect logs."]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Dockerfile"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dockerfile",children:'FROM node:20-alpine\nWORKDIR /app\n\nCOPY package.json package-lock.json* ./\nRUN npm ci\n\nCOPY tsconfig.json ./\nCOPY src ./src\nCOPY contracts ./contracts\nCOPY hardhat.config.ts ./\nRUN npm run build && npx hardhat compile && npm prune --omit=dev\n\nENV NODE_ENV=production\nCMD ["sh", "-c", "node dist/scripts/smoke-test.js || true; tail -f /dev/null"]\n'})})]}),"\n",(0,r.jsxs)(n.p,{children:["Mount the ",(0,r.jsx)(n.strong,{children:"appd socket"})," provided by ROFL. No public ports are exposed."]}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"compose.yaml"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"services:\n  demo:\n    image: docker.io/YOURUSER/rofl-keygen:0.1.0\n    platform: linux/amd64\n    environment:\n      - KEY_ID=${KEY_ID:-evm:base:sepolia}\n      - BASE_RPC_URL=${BASE_RPC_URL:-https://sepolia.base.org}\n      - BASE_CHAIN_ID=${BASE_CHAIN_ID:-84532}\n    volumes:\n      - /run/rofl-appd.sock:/run/rofl-appd.sock\n"})})]}),"\n",(0,r.jsx)(n.h2,{id:"build-the-image",children:"Build the image"}),"\n",(0,r.jsxs)(n.p,{children:["ROFL only runs on Intel TDX-enabled hardware so don't forget to pass the ",(0,r.jsx)(n.code,{children:"--platform linux/amd64"})," parameter if you're compiling images on a different host (e.g. macOS):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"docker buildx build --platform linux/amd64 \\\n  -t docker.io/YOURUSER/rofl-keygen:0.1.0 --push .\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For extra security and verifiability pin the digest and use ",(0,r.jsx)(n.code,{children:"image: ...@sha256:..."})," in ",(0,r.jsx)(n.code,{children:"compose.yaml"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"build-rofl-bundle",children:"Build ROFL bundle"}),"\n",(0,r.jsxs)(n.p,{children:["Before running the ",(0,r.jsx)(n.code,{children:"oasis rofl build"})," command, make sure to update the\n",(0,r.jsx)(n.code,{children:"services.demo.image"})," in ",(0,r.jsx)(n.code,{children:"compose.yaml"})," to the image you built."]}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["For TypeScript projects, image size may be larger, update the ",(0,r.jsx)(n.code,{children:"rofl.yaml"}),"\n",(0,r.jsx)(n.code,{children:"resources"})," section to at least: ",(0,r.jsx)(n.code,{children:"memory: 1024"})," and ",(0,r.jsx)(n.code,{children:"storage.size: 4096"}),"."]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oasis rofl build\n"})}),"\n",(0,r.jsx)(n.p,{children:"Then publish the enclave identities and config:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oasis rofl update\n"})}),"\n",(0,r.jsx)(n.h2,{id:"deploy",children:"Deploy"}),"\n",(0,r.jsx)(n.p,{children:"Deploy to a Testnet provider:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oasis rofl deploy\n"})}),"\n",(0,r.jsx)(n.h2,{id:"endtoend-base-sepolia",children:"End\u2011to\u2011end (Base Sepolia)"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"View smoke\u2011test logs"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oasis rofl machine logs\n"})}),"\n",(0,r.jsx)(n.p,{children:"You should see:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"App ID"}),"\n",(0,r.jsx)(n.li,{children:"EVM address and a signed message"}),"\n",(0,r.jsx)(n.li,{children:"A prompt to fund the address"}),"\n",(0,r.jsx)(n.li,{children:"After funding: a Counter.sol deployment"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Local dev (optional)"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Run ",(0,r.jsx)(n.code,{children:"npm run build:all"})," to compile the TypeScript code and the Solidity contract."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:" export ALLOW_LOCAL_DEV=true\n export LOCAL_DEV_SK=0x<64-hex-dev-secret-key>   # DO NOT USE IN PROD\n npm run smoke-test\n"})}),"\n",(0,r.jsx)(n.h2,{id:"security--notes",children:"Security & notes"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Never"})," log secret keys. Provider logs are not encrypted at rest."]}),"\n",(0,r.jsxs)(n.li,{children:["The appd socket ",(0,r.jsx)(n.code,{children:"/run/rofl-appd.sock"})," exists ",(0,r.jsx)(n.strong,{children:"only inside ROFL"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Public RPCs may rate\u2011limit; prefer a dedicated Base RPC URL."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["That\u2019s it! You generated a key in ROFL with ",(0,r.jsx)(n.strong,{children:"appd"}),", signed messages,\ndeployed a contract, and moved ETH on Base Sepolia."]}),"\n",(0,r.jsx)(n.admonition,{title:"Key Generation Demo",type:"example",children:(0,r.jsxs)(n.p,{children:["You can fetch a complete example shown in this chapter from\n",(0,r.jsx)(n.a,{href:"https://github.com/oasisprotocol/demo-rofl-keygen",children:"https://github.com/oasisprotocol/demo-rofl-keygen"}),"."]})})]})}function p(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);