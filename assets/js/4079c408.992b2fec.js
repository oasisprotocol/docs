"use strict";(globalThis.webpackChunkdocs_oasis_io=globalThis.webpackChunkdocs_oasis_io||[]).push([[7010],{6526:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"adrs/0013-runtime-upgrades","title":"ADR 0013: Runtime Upgrade Improvements","description":"Component","source":"@site/docs/adrs/0013-runtime-upgrades.md","sourceDirName":"adrs","slug":"/adrs/0013-runtime-upgrades","permalink":"/adrs/0013-runtime-upgrades","draft":false,"unlisted":false,"editUrl":"https://github.com/oasisprotocol/adrs/edit/main/0013-runtime-upgrades.md","tags":[],"version":"current","lastUpdatedAt":1754295238000,"frontMatter":{"sidebar_custom_props":{}},"sidebar":"adrs","previous":{"title":"ADR 0012: Runtime Message Results","permalink":"/adrs/0012-runtime-message-results"},"next":{"title":"ADR 0014: Signing Runtime Transactions with Hardware Wallet","permalink":"/adrs/0014-runtime-signing-tx-with-hardware-wallet"}}');var t=i(74848),r=i(28453);const o={sidebar_custom_props:{tags:void 0}},d="ADR 0013: Runtime Upgrade Improvements",l={},a=[{value:"Component",id:"component",level:2},{value:"Changelog",id:"changelog",level:2},{value:"Status",id:"status",level:2},{value:"Context",id:"context",level:2},{value:"Decision",id:"decision",level:2},{value:"Implementation",id:"implementation",level:2},{value:"Consequences",id:"consequences",level:2},{value:"Positive",id:"positive",level:3},{value:"Negative",id:"negative",level:3}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"adr-0013-runtime-upgrade-improvements",children:"ADR 0013: Runtime Upgrade Improvements"})}),"\n",(0,t.jsx)(n.h2,{id:"component",children:"Component"}),"\n",(0,t.jsx)(n.p,{children:"Oasis Core"}),"\n",(0,t.jsx)(n.h2,{id:"changelog",children:"Changelog"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"2022-01-25: Initial version"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"status",children:"Status"}),"\n",(0,t.jsx)(n.p,{children:"Accepted"}),"\n",(0,t.jsx)(n.h2,{id:"context",children:"Context"}),"\n",(0,t.jsx)(n.p,{children:"Currently major runtime updates incur at least one epoch worth of downtime\nfor the transition period.  This is suboptimal, and can be improved to allow\nseamless runtime updates, with some changes to the runtime descriptor and\nscheduler behavior."}),"\n",(0,t.jsx)(n.h2,{id:"decision",children:"Decision"}),"\n",(0,t.jsx)(n.p,{children:"Implement support for seamless breaking runtime upgrades."}),"\n",(0,t.jsx)(n.h2,{id:"implementation",children:"Implementation"}),"\n",(0,t.jsx)(n.p,{children:"Runtime descriptor related changes:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-golang",children:'// Runtime represents a runtime.\ntype Runtime struct { // nolint: maligned\n  // Deployments specifies the runtime deployments (versions).\n  Deployments []*VersionInfo `json:"deployments"`\n\n  // Version field is relocated to inside the VersionInfo structure.\n\n  // Other unchanged fields omitted for brevity.\n}\n\n// VersionInfo is the per-runtime version information.\ntype VersionInfo struct {\n  // Version of the runtime.\n  Version version.Version `json:"version"`\n\n  // ValidFrom stores the epoch at which, this version is valid.\n  ValidFrom beacon.EpochTime `json:"valid_from"`\n\n  // TEE is the enclave version information, in an enclave provider specific\n  // format if any.\n  TEE []byte `json:"tee,omitempty"`\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"The intended workflow here is to:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Deploy runtimes with the initial Deployment populated."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Update the runtime version via the deployment of a new version\nof the descriptor with an additional version info entry.\nSufficient nodes must upgrade their runtime binary and\nconfiguration by the ",(0,t.jsx)(n.code,{children:"ValidFrom"}),' epoch or the runtime will fail\nto be scheduled (no special handling is done, this is the existing\n"insufficient nodes" condition).']}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Aborting or altering pending updates via the deployment of a new version\nof the descriptor with the removed/ammended not-yet-valid ",(0,t.jsx)(n.code,{children:"Deployments"}),"\nis possible in this design, but perhaps should be forbidden."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Altering exisiting ",(0,t.jsx)(n.code,{children:"Deployments"})," entries is strictly forbidden,\nexcept the removal of superceded descriptors."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Deploying descriptors with ",(0,t.jsx)(n.code,{children:"Deployments"})," that will never be valid\n(as in one that is superceded by a newer version) is strictly\nforbidden."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The existing node descriptor is a flat vector of ",(0,t.jsx)(n.code,{children:"Runtime"})," entries\ncontaining the runtime ID, version, and TEE information, so no changes\nare required."]}),"\n",(0,t.jsxs)(n.p,{children:["On transition to an epoch where a new version takes effect, the consensus\nlayer MAY prune the descriptor's ",(0,t.jsx)(n.code,{children:"Deployments"})," field of superceded versions."]}),"\n",(0,t.jsx)(n.p,{children:"The only scheduler and worker side changes are to incorporate the runtime\nversion into scheduling, and to pick the correct deployed version of the\nruntime to use, both on a once-per-epoch-per-runtime basis."}),"\n",(0,t.jsx)(n.h2,{id:"consequences",children:"Consequences"}),"\n",(0,t.jsx)(n.h3,{id:"positive",children:"Positive"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Seamless runtime upgrades will be possible."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"The code changes required are relatively minimal, and this is likely\nthe simplest possible solution that will work."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"negative",children:"Negative"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"It may be overly simplistic."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>d});var s=i(96540);const t={},r=s.createContext(t);function o(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);