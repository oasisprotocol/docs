"use strict";(globalThis.webpackChunkdocs_oasis_io=globalThis.webpackChunkdocs_oasis_io||[]).push([[2486],{11470:(e,n,t)=>{t.d(n,{A:()=>A});var r=t(96540),s=t(34164),i=t(17559),a=t(23104),o=t(56347),c=t(205),l=t(57485),d=t(31682),h=t(70679);function p(e){return r.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function u(e){const{values:n,children:t}=e;return(0,r.useMemo)(()=>{const e=n??function(e){return p(e).map(({props:{value:e,label:n,attributes:t,default:r}})=>({value:e,label:n,attributes:t,default:r}))}(t);return function(e){const n=(0,d.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,t])}function y({value:e,tabValues:n}){return n.some(n=>n.value===e)}function m({queryString:e=!1,groupId:n}){const t=(0,o.W6)(),s=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,l.aZ)(s),(0,r.useCallback)(e=>{if(!s)return;const n=new URLSearchParams(t.location.search);n.set(s,e),t.replace({...t.location,search:n.toString()})},[s,t])]}function x(e){const{defaultValue:n,queryString:t=!1,groupId:s}=e,i=u(e),[a,o]=(0,r.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!y({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const t=n.find(e=>e.default)??n[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:n,tabValues:i})),[l,d]=m({queryString:t,groupId:s}),[p,x]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[t,s]=(0,h.Dv)(n);return[t,(0,r.useCallback)(e=>{n&&s.set(e)},[n,s])]}({groupId:s}),f=(()=>{const e=l??p;return y({value:e,tabValues:i})?e:null})();(0,c.A)(()=>{f&&o(f)},[f]);return{selectedValue:a,selectValue:(0,r.useCallback)(e=>{if(!y({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);o(e),d(e),x(e)},[d,x,i]),tabValues:i}}var f=t(92303);const g={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var b=t(74848);function v({className:e,block:n,selectedValue:t,selectValue:r,tabValues:i}){const o=[],{blockElementScrollPositionUntilNextRender:c}=(0,a.a_)(),l=e=>{const n=e.currentTarget,s=o.indexOf(n),a=i[s].value;a!==t&&(c(n),r(a))},d=e=>{let n=null;switch(e.key){case"Enter":l(e);break;case"ArrowRight":{const t=o.indexOf(e.currentTarget)+1;n=o[t]??o[0];break}case"ArrowLeft":{const t=o.indexOf(e.currentTarget)-1;n=o[t]??o[o.length-1];break}}n?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,s.A)("tabs",{"tabs--block":n},e),children:i.map(({value:e,label:n,attributes:r})=>(0,b.jsx)("li",{role:"tab",tabIndex:t===e?0:-1,"aria-selected":t===e,ref:e=>{o.push(e)},onKeyDown:d,onClick:l,...r,className:(0,s.A)("tabs__item",g.tabItem,r?.className,{"tabs__item--active":t===e}),children:n??e},e))})}function j({lazy:e,children:n,selectedValue:t}){const i=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=i.find(e=>e.props.value===t);return e?(0,r.cloneElement)(e,{className:(0,s.A)("margin-top--md",e.props.className)}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:i.map((e,n)=>(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==t}))})}function k(e){const n=x(e);return(0,b.jsxs)("div",{className:(0,s.A)(i.G.tabs.container,"tabs-container",g.tabList),children:[(0,b.jsx)(v,{...n,...e}),(0,b.jsx)(j,{...n,...e})]})}function A(e){const n=(0,f.A)();return(0,b.jsx)(k,{...e,children:p(e.children)},String(n))}},19365:(e,n,t)=>{t.d(n,{A:()=>a});t(96540);var r=t(34164);const s={tabItem:"tabItem_Ymn6"};var i=t(74848);function a({children:e,hidden:n,className:t}){return(0,i.jsx)("div",{role:"tabpanel",className:(0,r.A)(s.tabItem,t),hidden:n,children:e})}},21524:(e,n,t)=>{t.d(n,{A:()=>m});t(96540);var r=t(34164),s=t(28774),i=t(26972),a=t(53465),o=t(16654),c=(t(21312),t(51107));const l={cardContainer:"cardContainer_S8oU",cardTitle:"cardTitle_HoSo",cardDescription:"cardDescription_c27F"};var d=t(74848);function h({href:e,children:n,className:t}){return(0,d.jsx)(s.A,{href:e,className:(0,r.A)("card padding--lg",l.cardContainer,t),children:n})}function p({href:e,icon:n,title:t,description:s,customProps:i,className:a}){return(0,d.jsxs)(h,{href:e,className:a,children:[(0,d.jsx)(c.A,{as:"h3",className:(0,r.A)("text--truncate",l.cardTitle),title:t,children:t}),s&&(0,d.jsx)("p",{className:(0,r.A)("text--truncate",l.cardDescription),title:s,children:s}),i?.tags&&Array.isArray(i.tags)?(0,d.jsx)("div",{className:"pill",children:i.tags.map(e=>(0,d.jsx)("div",{className:"pills__item pills__item--active tag ",children:e},e))}):null]})}function u({item:e,className:n}){const t=(0,i.Nr)(e);!function(){const{selectMessage:e}=(0,a.W)()}();return t?(0,d.jsx)(p,{href:t,icon:"\ud83d\uddc3\ufe0f",title:e.label,description:e.description,customProps:e.customProps,className:n}):null}function y({item:e,className:n}){const t=(0,o.A)(e.href)?"\ud83d\udcc4\ufe0f":"\ud83d\udd17",r=(0,i.cC)(e.docId??void 0);return(0,d.jsx)(p,{href:e.href,icon:t,title:e.label,description:e.description??r?.description,customProps:e.customProps,className:n})}function m({item:e}){switch(e.type){case"link":return(0,d.jsx)(y,{item:e,className:"exclude-from-search"});case"category":return(0,d.jsx)(u,{item:e,className:"exclude-from-search"});default:throw new Error(`unknown item type ${JSON.stringify(e)}`)}}},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var r=t(96540);const s={},i=r.createContext(s);function a(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(i.Provider,{value:n},e.children)}},53465:(e,n,t)=>{t.d(n,{W:()=>l});var r=t(96540),s=t(44586);const i=["zero","one","two","few","many","other"];function a(e){return i.filter(n=>e.includes(n))}const o={locale:"en",pluralForms:a(["one","other"]),select:e=>1===e?"one":"other"};function c(){const{i18n:{currentLocale:e}}=(0,s.A)();return(0,r.useMemo)(()=>{try{return function(e){const n=new Intl.PluralRules(e);return{locale:e,pluralForms:a(n.resolvedOptions().pluralCategories),select:e=>n.select(e)}}(e)}catch(n){return console.error(`Failed to use Intl.PluralRules for locale "${e}".\nDocusaurus will fallback to the default (English) implementation.\nError: ${n.message}\n`),o}},[e])}function l(){const e=c();return{selectMessage:(n,t)=>function(e,n,t){const r=e.split("|");if(1===r.length)return r[0];r.length>t.pluralForms.length&&console.error(`For locale=${t.locale}, a maximum of ${t.pluralForms.length} plural forms are expected (${t.pluralForms.join(",")}), but the message contains ${r.length}: ${e}`);const s=t.select(n),i=t.pluralForms.indexOf(s);return r[Math.min(i,r.length-1)]}(t,n,e)}}},56116:(e,n,t)=>{t.d(n,{$:()=>a});var r=t(23025),s=t(44586);function i(e){for(const n of e){const e=n.href;e&&void 0===globalThis.sidebarItemsMap[e]&&(globalThis.sidebarItemsMap[e]=n),"category"===n.type&&i(n.items)}}function a(e){const{siteConfig:n,siteMetadata:t}=(0,s.A)(),a=(0,r.r)();if(!a)throw new Error("Unexpected: cant find docsVersion in current context");if(void 0===globalThis.sidebarItemsMap){globalThis.sidebarItemsMap={};for(const e in a.docsSidebars)i(a.docsSidebars[e])}if(void 0===globalThis.sidebarItemsMap[e]){if(console.log(`Item ${e} not found. Registered sidebar items:`),console.log(globalThis.sidebarItemsMap),"throw"==n.onBrokenMarkdownLinks)throw new Error(`Unexpected: sidebar item with href ${e} does not exist.`);return globalThis.sidebarItemsMap["/general/"]}return globalThis.sidebarItemsMap[e]}},97496:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>h,default:()=>m,frontMatter:()=>d,metadata:()=>r,toc:()=>u});const r=JSON.parse('{"id":"build/sapphire/develop/encrypted-events","title":"Encrypted Events","description":"Emit confidential event data on Sapphire that only specific users can read, while keeping logs indexable.","source":"@site/docs/build/sapphire/develop/encrypted-events.mdx","sourceDirName":"build/sapphire/develop","slug":"/build/sapphire/develop/encrypted-events","permalink":"/build/sapphire/develop/encrypted-events","draft":false,"unlisted":false,"editUrl":"https://github.com/oasisprotocol/sapphire-paratime/edit/main/docs/develop/encrypted-events.mdx","tags":[],"version":"current","lastUpdatedAt":1767971595000,"frontMatter":{"title":"Encrypted Events","description":"Emit confidential event data on Sapphire that only specific users can read, while keeping logs indexable.","sidebar_custom_props":{}},"sidebar":"developers","previous":{"title":"Gasless Transactions","permalink":"/build/sapphire/develop/gasless"},"next":{"title":"Deployment Patterns","permalink":"/build/sapphire/develop/deployment"}}');var s=t(74848),i=t(28453),a=t(11470),o=t(19365),c=t(21524),l=t(56116);const d={title:"Encrypted Events",description:"Emit confidential event data on Sapphire that only specific users can read, while keeping logs indexable.",sidebar_custom_props:{tags:void 0}},h=void 0,p={},u=[{value:"How it Works: Basic Concept",id:"how-it-works-basic-concept",level:2},{value:"The <code>Encrypted</code> Event",id:"the-encrypted-event",level:3},{value:"On-Chain Encryption",id:"on-chain-encryption",level:3},{value:"Off-Chain Decryption",id:"off-chain-decryption",level:3},{value:"Pattern 1: Passing a Symmetric Key",id:"pattern-1-passing-a-symmetric-key",level:2},{value:"TypeScript: generate a <code>bytes32</code> key",id:"typescript-generate-a-bytes32-key",level:3},{value:"Contract Implementation",id:"contract-implementation",level:3},{value:"Pattern 2: Deriving a Symmetric Key (ECDH)",id:"pattern-2-deriving-a-symmetric-key-ecdh",level:2},{value:"Contract Implementation (ECDH)",id:"contract-implementation-ecdh",level:3},{value:"Off-Chain Key Derivation",id:"off-chain-key-derivation",level:3},{value:"Recommended: Bind Ciphertext with AAD",id:"recommended-bind-ciphertext-with-aad",level:3},{value:"Option A: Sender\u2011Bound AAD",id:"option-a-senderbound-aad",level:4},{value:"Option B: Context\u2011Bound AAD",id:"option-b-contextbound-aad",level:4},{value:"Pattern 3: On-chain Key Generation (ROFL-friendly)",id:"pattern-3-on-chain-key-generation-rofl-friendly",level:2},{value:"Contract Sketch",id:"contract-sketch",level:3},{value:"Important Notes",id:"important-notes",level:2}];function y(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["On standard blockchains, all event data is public. Oasis Sapphire's\nconfidential EVM allows you to encrypt an event's ",(0,s.jsx)(n.strong,{children:"payload"}),", keeping\nsensitive data private while the event topics remain public for indexing and\noff-chain triggers. This unlocks powerful new use cases for dApps that need to\nlog private information."]}),"\n",(0,s.jsxs)(n.p,{children:["In this chapter, you'll learn ",(0,s.jsx)(n.strong,{children:"three"})," patterns for encrypting event data:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsxs)(n.strong,{children:[(0,s.jsx)(n.a,{href:"#pattern-1-passing-a-symmetric-key",children:"Passing a Symmetric Key"}),":"]})," A client\npasses a secret key directly to the contract in an encrypted transaction."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsxs)(n.strong,{children:[(0,s.jsx)(n.a,{href:"#pattern-2-deriving-a-symmetric-key-ecdh",children:"Deriving a Symmetric Key (ECDH)"}),":"]}),"\nThe contract and client use Elliptic Curve Diffie-Hellman (ECDH) to derive\na shared secret key."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsxs)(n.strong,{children:[(0,s.jsx)(n.a,{href:"#pattern-3-on-chain-key-generation-rofl-friendly",children:"On\u2011chain Key Generation (ROFL\u2011friendly)"}),":"]}),"\nThe contract generates a symmetric key on-chain and exposes a guarded\npublic function intended for ROFL-based consumers."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["We'll cover the on-chain smart contract logic and the off-chain decryption\nprocess. A full working example is available inside the\n",(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.a,{href:"https://github.com/oasisprotocol/sapphire-paratime/tree/main/examples/encrypted-events",children:"Sapphire Examples"})})," folder."]}),"\n",(0,s.jsx)(n.h2,{id:"how-it-works-basic-concept",children:"How it Works: Basic Concept"}),"\n",(0,s.jsxs)(n.p,{children:["To emit the encrypted event you need to ",(0,s.jsx)(n.strong,{children:"define an event"}),",\n",(0,s.jsx)(n.strong,{children:"generate a nonce"}),", ",(0,s.jsx)(n.strong,{children:"encrypt the text"})," with\nadditional authenticated data (AAD), and finally ",(0,s.jsx)(n.strong,{children:"emit the ciphertext"}),".\nHow you obtain the key is covered in the specific pattern subsection below."]}),"\n",(0,s.jsxs)(n.h3,{id:"the-encrypted-event",children:["The ",(0,s.jsx)(n.code,{children:"Encrypted"})," Event"]}),"\n",(0,s.jsx)(n.p,{children:"Define a standard event signature in your contract. This structure is shared by\nall patterns."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-solidity",children:"// In your contract\nevent Encrypted(address indexed sender, bytes32 nonce, bytes ciphertext);\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"sender"}),": The address that initiated the encryption. Indexing it helps in\nfiltering events."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"nonce"}),": A unique number used once per encryption with a given key. ",(0,s.jsx)(n.strong,{children:"Never\nreuse a key/nonce pair!"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ciphertext"}),": The encrypted data payload."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"on-chain-encryption",children:"On-Chain Encryption"}),"\n",(0,s.jsx)(n.p,{children:"Sapphire provides a precompile for encryption. The basic flow inside a contract\nfunction is:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Get a Nonce:"})," Generate a fresh, random nonce for each encryption with\n",(0,s.jsx)(n.a,{href:"https://api.docs.oasis.io/sol/sapphire-contracts/contracts/Sapphire.sol/library.Sapphire.html#randombytes",children:(0,s.jsx)(n.code,{children:"Sapphire.randomBytes"})}),". Passing a domain separator is good practice."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-solidity",children:'// A 32-byte nonce for Deoxys-II, which uses the first 15 bytes\nbytes32 nonce = bytes32(Sapphire.randomBytes(32, bytes("my-dapp-nonce")));\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Encrypt the Data:"})," Use ",(0,s.jsx)(n.a,{href:"https://api.docs.oasis.io/sol/sapphire-contracts/contracts/Sapphire.sol/library.Sapphire.html#encrypt-1",children:(0,s.jsx)(n.code,{children:"Sapphire.encrypt"})})," with a key, the nonce, your\ntext (plaintext), and additional authenticated data."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-solidity",children:'// Keep names identical to the library\nbytes memory ad = "additional data";\nbytes memory encrypted = Sapphire.encrypt(key, nonce, text, ad);\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Emit the Event:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-solidity",children:"emit Encrypted(msg.sender, nonce, encrypted);\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"off-chain-decryption",children:"Off-Chain Decryption"}),"\n",(0,s.jsxs)(n.p,{children:["To read the secret text, an off-chain client with the correct key listens for\n",(0,s.jsx)(n.code,{children:"Encrypted"})," events and decrypts the ",(0,s.jsx)(n.code,{children:"ciphertext"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { AEAD, NonceSize } from '@oasisprotocol/deoxysii';\nimport { ethers } from 'ethers';\n\n// You need:\n// - key: A Uint8Array(32) symmetric key\n// - nonceFromEvent: The 'nonce' field from the event log\n// - ciphertextFromEvent: The 'ciphertext' field from the event log\n// - ad: AAD bytes if used on-chain (a.k.a. \"authenticated data\")\n\nconst aead = new AEAD(key);\n\nconst plaintext = aead.decrypt(\n  // IMPORTANT: Deoxys-II uses a 15-byte nonce.\n  // We slice the first 15 bytes from the 32-byte value stored on-chain.\n  ethers.getBytes(nonceFromEvent).slice(0, NonceSize),\n  ethers.getBytes(ciphertextFromEvent),\n  ad,\n);\n\nconsole.log('Decrypted message:', ethers.toUtf8String(plaintext));\n"})}),"\n",(0,s.jsx)(n.h2,{id:"pattern-1-passing-a-symmetric-key",children:"Pattern 1: Passing a Symmetric Key"}),"\n",(0,s.jsx)(n.p,{children:"This is the simplest approach. The client generates a 32\u2011byte symmetric key and\npasses it to the smart contract as an argument inside the encrypted\ntransaction."}),"\n",(0,s.jsxs)(n.h3,{id:"typescript-generate-a-bytes32-key",children:["TypeScript: generate a ",(0,s.jsx)(n.code,{children:"bytes32"})," key"]}),"\n",(0,s.jsxs)(a.A,{children:[(0,s.jsx)(o.A,{value:"ethers",label:"Ethers",default:!0,children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import { ethers } from 'ethers';\n\nconst key = ethers.randomBytes(32); // Uint8Array\nconst keyHex = ethers.hexlify(key) as `0x${string}`; // for contract calls\n\n// Pass keyHex directly to a Solidity function taking `bytes32 key`.\n// Use the `key` (Uint8Array) for off-chain decryption.\n"})})}),(0,s.jsx)(o.A,{value:"node",label:"Node.js",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import { ethers } from 'ethers';\nimport { randomBytes } from 'crypto';\n\nconst key = randomBytes(32); // Buffer, compatible with Uint8Array\nconst keyHex = ethers.hexlify(key) as `0x${string}`; // for contract calls\n\n// Pass keyHex directly to a Solidity function taking `bytes32 key`.\n// Use the `key` (Buffer) for off-chain decryption.\n"})})})]}),"\n",(0,s.jsx)(n.h3,{id:"contract-implementation",children:"Contract Implementation"}),"\n",(0,s.jsx)(n.p,{children:"The function takes the key and the text, encrypts, and emits the event."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-solidity",metastring:'title="EncryptedEvents.sol"',children:'import { Sapphire } from "@oasisprotocol/sapphire-contracts/contracts/Sapphire.sol";\n\ncontract EncryptedEvents {\n    event Encrypted(address indexed sender, bytes32 nonce, bytes ciphertext);\n\n    function emitEncrypted(bytes32 key, bytes calldata text) external {\n        bytes32 nonce = bytes32(Sapphire.randomBytes(32, bytes("my-dapp-nonce")));\n        bytes memory ad = bytes(""); // optional AAD\n        bytes memory encrypted = Sapphire.encrypt(key, nonce, text, ad);\n        emit Encrypted(msg.sender, nonce, encrypted);\n    }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"The off-chain client is responsible for managing this key and using it for\ndecryption as shown above."}),"\n",(0,s.jsx)(n.h2,{id:"pattern-2-deriving-a-symmetric-key-ecdh",children:"Pattern 2: Deriving a Symmetric Key (ECDH)"}),"\n",(0,s.jsxs)(n.p,{children:["In this more advanced pattern, you don't send a key with every transaction.\nInstead, the contract holds a long\u2011lived Curve25519 secret key (in\nconfidential state), and a shared secret is ",(0,s.jsx)(n.strong,{children:"derived on\u2011chain"})," from the\ncaller\u2019s public key using X25519 (ECDH)."]}),"\n",(0,s.jsx)(n.h3,{id:"contract-implementation-ecdh",children:"Contract Implementation (ECDH)"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Generate a Keypair:"})," In the constructor, generate a Curve25519 keypair and\nstore the secret key in confidential state. The public key can be exposed\nfor clients."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-solidity",metastring:'title="EncryptedEventsECDH.sol"',children:'contract EncryptedEventsECDH {\n    Sapphire.Curve25519SecretKey private _contractSk;\n    Sapphire.Curve25519PublicKey public contractPk;\n\n    constructor() {\n        (Sapphire.Curve25519PublicKey pk, Sapphire.Curve25519SecretKey sk) =\n            Sapphire.generateCurve25519KeyPair(bytes(""));\n        contractPk = pk;\n        _contractSk = sk;\n    }\n    // ...\n}\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Derive and Encrypt:"})," The emit function now takes the caller's public key,\nderives the shared key, encrypts the text, and emits the event."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-solidity",metastring:'title="EncryptedEventsECDH.sol"',children:'function emitEncryptedECDH(\n    Sapphire.Curve25519PublicKey callerPublicKey,\n    bytes calldata text\n) external {\n    // Derive the shared symmetric key\n    bytes32 key = Sapphire.deriveSymmetricKey(callerPublicKey, _contractSk);\n\n    // Encrypt and emit as before\n    bytes32 nonce = bytes32(Sapphire.randomBytes(32, bytes("my-dapp-nonce")));\n    bytes memory ad = bytes(""); // optional AAD\n    bytes memory encrypted = Sapphire.encrypt(key, nonce, text, ad);\n    emit Encrypted(msg.sender, nonce, encrypted);\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"off-chain-key-derivation",children:"Off-Chain Key Derivation"}),"\n",(0,s.jsxs)(n.p,{children:["The client derives the shared key from its ",(0,s.jsx)(n.strong,{children:"secret"})," and the contract\u2019s\n",(0,s.jsx)(n.strong,{children:"public"})," key."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { mraeDeoxysii } from '@oasisprotocol/client-rt';\nimport { AEAD } from '@oasisprotocol/deoxysii';\nimport { ethers } from 'ethers';\n\n// contractPkHex: 0x-prefixed Curve25519 public key (bytes32) fetched on-chain\n// callerSkBytes: Uint8Array(32) caller's Curve25519 secret key\nconst sharedKey = mraeDeoxysii.deriveSymmetricKey(\n  ethers.getBytes(contractPkHex),\n  callerSkBytes,\n);\n\nconst aead = new AEAD(sharedKey);\n// ... decrypt with aead.decrypt() as shown earlier.\n"})}),"\n",(0,s.jsx)(n.h3,{id:"recommended-bind-ciphertext-with-aad",children:"Recommended: Bind Ciphertext with AAD"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Additional Authenticated Data (AAD)"})," binds a ciphertext to its context. If\nthe bytes don\u2019t match during decryption, it fails. Provide the ",(0,s.jsx)(n.strong,{children:"same bytes"}),"\nto ",(0,s.jsx)(n.a,{href:"https://api.docs.oasis.io/sol/sapphire-contracts/contracts/Sapphire.sol/library.Sapphire.html#encrypt-1",children:(0,s.jsx)(n.code,{children:"Sapphire.encrypt"})})," on-chain (as ",(0,s.jsx)(n.code,{children:"ad"}),") and to ",(0,s.jsx)(n.code,{children:"AEAD.decrypt"})," off-chain (as\n",(0,s.jsx)(n.code,{children:"adBytes"}),")."]}),"\n",(0,s.jsx)(n.h4,{id:"option-a-senderbound-aad",children:"Option A: Sender\u2011Bound AAD"}),"\n",(0,s.jsxs)(n.p,{children:["Bind to ",(0,s.jsx)(n.code,{children:"msg.sender"})," (useful for user-specific data)."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"On-Chain AAD:"})," ",(0,s.jsx)(n.code,{children:"bytes memory ad = abi.encodePacked(msg.sender);"})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Off-Chain AAD:"})," Get the ",(0,s.jsx)(n.code,{children:"sender"})," from the event log and convert to bytes."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const adBytes = ethers.getBytes(senderAddress); // 20 bytes\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"option-b-contextbound-aad",children:"Option B: Context\u2011Bound AAD"}),"\n",(0,s.jsx)(n.p,{children:"Bind to the (chain, contract). This is relayer\u2011agnostic."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"On-Chain AAD:"})," ",(0,s.jsx)(n.code,{children:"bytes memory ad = abi.encodePacked(block.chainid, address(this));"})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Off-Chain AAD:"})," Reconstruct the same packed bytes."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const { chainId } = await provider.getNetwork();\nconst adBytes = ethers.getBytes(\n  ethers.solidityPacked(['uint256', 'address'], [chainId, contractAddress]),\n);\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"pattern-3-on-chain-key-generation-rofl-friendly",children:"Pattern 3: On-chain Key Generation (ROFL-friendly)"}),"\n",(0,s.jsxs)(n.p,{children:["For ",(0,s.jsx)(n.strong,{children:"ROFL"})," containers and similar trusted off-chain compute, you may prefer\nto ",(0,s.jsx)(n.strong,{children:"generate the symmetric key on-chain"})," and expose a ",(0,s.jsx)(n.strong,{children:"guarded"})," public\nfunction that encrypts and emits events. The ROFL worker fetches events and\nuses its corresponding secret material to decrypt."]}),"\n",(0,s.jsx)(c.A,{item:(0,l.$)("/build/rofl/")}),"\n",(0,s.jsx)(n.h3,{id:"contract-sketch",children:"Contract Sketch"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-solidity",metastring:'title="EncryptedEventsROFL.sol"',children:'import {Sapphire} from "@oasisprotocol/sapphire-contracts/contracts/Sapphire.sol";\n\ncontract EncryptedEventsROFL {\n    event Encrypted(address indexed sender, bytes32 nonce, bytes ciphertext);\n\n    // IMPORTANT: This is a sketch. Do **not** deploy this contract as-is.\n    // Replace this with a real ROFL/OPL authorization scheme (e.g., allowlist,\n    // appd/attestation checks, marketplace\u2011managed identities, etc.).\n    address public roflApp; // set to your ROFL app\'s address in your deployment flow\n\n    modifier onlyROFL() {\n        require(msg.sender == roflApp, "only ROFL app");\n        _;\n    }\n\n    function emitWithOnchainKey(bytes calldata text) external onlyROFL {\n        // 1) Generate a fresh symmetric key on-chain (per call or per session)\n        bytes32 key = bytes32(Sapphire.randomBytes(32, bytes("rofl:onchain:key")));\n\n        // 2) Encrypt with optional context-binding AAD\n        bytes32 nonce = bytes32(Sapphire.randomBytes(32, bytes("rofl:nonce")));\n        bytes memory ad = abi.encodePacked(block.chainid, address(this));\n        bytes memory encrypted = Sapphire.encrypt(key, nonce, text, ad);\n\n        // 3) Emit\n        emit Encrypted(msg.sender, nonce, encrypted);\n\n        // Optionally: persist or wrap `key` for ROFL retrieval using your chosen scheme.\n        // Do NOT emit or log secrets in production.\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"important-notes",children:"Important Notes"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Carefully store the secret key"}),": Keep the key ",(0,s.jsx)(n.strong,{children:"inside"})," the\ncontract/state or wrap it for ROFL; never emit it."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Replay attacks"}),": Always use ",(0,s.jsx)(n.a,{href:"#recommended-bind-ciphertext-with-aad",children:"AAD"}),"\nto bind ciphertexts to contract/chain or sender."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"ROFL key derivation"}),": If you're deriving event encryption keys inside\nROFL, ensure the derivation mirrors your on-chain logic."]}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{title:"Encrypted Events",type:"example",children:(0,s.jsxs)(n.p,{children:["See the ",(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.a,{href:"https://github.com/oasisprotocol/sapphire-paratime/tree/main/examples/encrypted-events",children:"Encrypted Events Demo"})})," example folder\nfor end-to-end Hardhat tasks to deploy, emit, and decrypt events using the\npatterns above, plus tests and a step-by-step tutorial."]})})]})}function m(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(y,{...e})}):y(e)}}}]);