"use strict";(globalThis.webpackChunkdocs_oasis_io=globalThis.webpackChunkdocs_oasis_io||[]).push([[22],{1903:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>p,frontMatter:()=>l,metadata:()=>a,toc:()=>u});const a=JSON.parse('{"id":"build/sapphire/develop/security","title":"Security","description":"Recipes for Confidentiality, Security considerations when writing confidential contracts","source":"@site/docs/build/sapphire/develop/security.md","sourceDirName":"build/sapphire/develop","slug":"/build/sapphire/develop/security","permalink":"/build/sapphire/develop/security","draft":false,"unlisted":false,"editUrl":"https://github.com/oasisprotocol/sapphire-paratime/edit/main/docs/develop/security.md","tags":[],"version":"current","lastUpdatedAt":1760874442000,"frontMatter":{"description":"Recipes for Confidentiality, Security considerations when writing confidential contracts","sidebar_custom_props":{}},"sidebar":"developers","previous":{"title":"Deployment Patterns","permalink":"/build/sapphire/develop/deployment"},"next":{"title":"Testing","permalink":"/build/sapphire/develop/testing"}}');var r=t(74848),s=t(28453),i=t(11470),o=t(19365);const l={description:"Recipes for Confidentiality, Security considerations when writing confidential contracts",sidebar_custom_props:{tags:void 0}},c="Security",d={},u=[{value:"Storage Access Patterns",id:"storage-access-patterns",level:2},{value:"Order of Operations",id:"order-of-operations",level:2},{value:"Speed Bump",id:"speed-bump",level:2},{value:"Gas Padding",id:"gas-padding",level:2},{value:"Example attack (leaky code path)",id:"example-attack-leaky-code-path",level:3},{value:"Fix with padding",id:"fix-with-padding",level:3},{value:"When to use",id:"when-to-use",level:3},{value:"When <em>not</em> to rely on it (alone)",id:"when-not-to-rely-on-it-alone",level:3},{value:"Masking input size (guidance)",id:"masking-input-size-guidance",level:3},{value:"Simple example",id:"simple-example",level:4}];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"security",children:"Security"})}),"\n",(0,r.jsx)(n.p,{children:"This page is an ongoing work in progress to support confidential smart contract\ndevelopment. At the moment we address safeguarding storage variable access\npatterns and provide best practices for more secure orderings of error checking\nto prevent leaking contract state."}),"\n",(0,r.jsx)(n.h2,{id:"storage-access-patterns",children:"Storage Access Patterns"}),"\n",(0,r.jsxs)(n.p,{children:["You can use a tool such as ",(0,r.jsx)(n.a,{href:"https://www.npmjs.com/package/hardhat-tracer",children:"hardhat-tracer"})," to examine the base EVM state\ntransitions under the hood."]}),"\n",(0,r.jsxs)(i.A,{groupId:"npm2yarn",children:[(0,r.jsx)(o.A,{value:"npm",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"npm install -D hardhat-tracer\n"})})}),(0,r.jsx)(o.A,{value:"pnpm",label:"pnpm",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"pnpm add -D hardhat-tracer\n"})})}),(0,r.jsx)(o.A,{value:"yarn",label:"Yarn",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"yarn add --dev hardhat-tracer\n"})})})]}),"\n",(0,r.jsxs)(n.p,{children:["and add ",(0,r.jsx)(n.code,{children:"hardhat-tracer"})," to your ",(0,r.jsx)(n.code,{children:"config.ts"})," file,"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'import "hardhat-tracer"\n'})}),"\n",(0,r.jsx)(n.p,{children:"in order to test and show call traces."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"npx hardhat test --vvv --opcodes SSTORE,SLOAD\n"})}),"\n",(0,r.jsx)(n.p,{children:"You can also trace a particular transaction, once you know its hash."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"npx hardhat trace --hash 0xTransactionHash\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For both ",(0,r.jsx)(n.a,{href:"https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html",children:"gas"})," usage and confidentiality purposes, we ",(0,r.jsx)(n.strong,{children:"recommend using\nnon-unique data size"}),". E.g. 64-byte value will still be distinct from a\n128-byte value."]}),"\n",(0,r.jsx)(n.admonition,{title:"Inference based on access patterns",type:"caution",children:(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"SSTORE"})," keys from one transaction may be linked to ",(0,r.jsx)(n.code,{children:"SLOAD"})," keys of another\ntransaction."]})}),"\n",(0,r.jsx)(n.h2,{id:"order-of-operations",children:"Order of Operations"}),"\n",(0,r.jsxs)(n.p,{children:["When handling errors, gas usage patterns not only can reveal the code path\ntaken, ",(0,r.jsx)(n.strong,{children:"but sometimes the balance of a user as well"})," (in the case of a diligent\nattacker using binary search)."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:"function transferFrom(address who, address to, uint amount)\n  external\n{\n  require( balances[who] >= amount );\n  require( allowances[who][msg.sender] >= amount );\n  // ...\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Modifying the order of error checking can prevent the accidental disclosure of\nbalance information in the example above."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:"function transferFrom(address who, address to, uint amount)\n  external\n{\n  require( allowances[who][msg.sender] >= amount );\n  require( balances[who] >= amount );\n  // ...\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"speed-bump",children:"Speed Bump"}),"\n",(0,r.jsx)(n.p,{children:"If we would like to prevent off-chain calls from being chained together, we can\nensure that the block has been finalized."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:'contract Secret {\n  uint256 private _height;\n  bytes private _secret;\n  address private _buyer;\n\n  constructor(bytes memory _text) {\n    _secret = _text;\n  }\n\n  function recordPayment() external payable {\n    require(msg.value == 1 ether);\n    // set and lock buyer\n    _height = block.number;\n    _buyer = msg.sender;\n  }\n\n  /// @notice Reveals the secret.\n  function revealSecret() view external returns (bytes memory) {\n    require(block.number > _height, "not settled");\n    require(_buyer != address(0), "no recorded buyer");\n    // TODO: optionally authenticate call from buyer\n    return _secret;\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"gas-padding",children:"Gas Padding"}),"\n",(0,r.jsxs)(n.p,{children:["Gas padding lets you equalize ",(0,r.jsx)(n.strong,{children:"EVM execution"})," gas across private code paths to\nreduce side\u2011channel leakage. Sapphire provides a precompile\n(",(0,r.jsx)(n.a,{href:"https://api.docs.oasis.io/sol/sapphire-contracts/contracts/Sapphire.sol/library.Sapphire.html#padgas",children:(0,r.jsx)(n.code,{children:"Sapphire.padGas"})}),") that burns execution gas so that your\nfunction\u2019s execution cost is brought up to a target amount. The gas padding\ncall is usually done somewhere at the end of the executed code to cover all\npossible execution paths."]}),"\n",(0,r.jsx)(n.p,{children:"Scope & limits:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Pads ",(0,r.jsx)(n.strong,{children:"only the EVM engine (execution) gas"})," spent by your contract\u2019s code\npath. It ",(0,r.jsx)(n.strong,{children:"does not"})," include the intrinsic/transaction\u2011size component\n(calldata bytes, signature, envelope, etc.). The transaction size and the fee\nattributable to it remains public."]}),"\n",(0,r.jsxs)(n.li,{children:["Practically: if you pad to ",(0,r.jsx)(n.code,{children:"10_000"}),", the total fee is ",(0,r.jsx)(n.code,{children:"tx_size_gas + exec_gas_padded(\u224810_000)"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Padding is intentionally limited to the execution layer. If total gas were\nfully padded, an attacker could vary transaction size to leak information;\ntherefore only the EVM execution portion is padded."}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"padGas"})," protects the code path ",(0,r.jsx)(n.strong,{children:"within your contract"}),". Gas used by\nexternal calls can still differ unless those contracts also pad."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"example-attack-leaky-code-path",children:"Example attack (leaky code path)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:"contract Leaky {\n  bytes32 private secret;\n  bytes32 private tmp;\n\n  // Returns true on correct guess; success path does extra work\n  // (leaks via fee).\n  function guess(bytes32 candidate) external returns (bool ok) {\n    if (candidate == secret) {\n      for (uint i = 0; i < 10_000; ++i) {\n        tmp = keccak256(abi.encodePacked(tmp, i));\n      }\n      return true;\n    }\n    return false;\n  }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["An observer (or the caller) can compare total fees and infer whether\n",(0,r.jsx)(n.code,{children:"candidate == secret"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"fix-with-padding",children:"Fix with padding"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:"contract Padded {\n  bytes32 private secret;\n  bytes32 private tmp;\n\n  function guess(bytes32 candidate) external returns (bool ok) {\n    if (candidate == secret) {\n      for (uint i = 0; i < 10_000; ++i) {\n        tmp = keccak256(abi.encodePacked(tmp, i));\n      }\n      ok = true;\n    }\n    // Equalize execution cost across branches. Pads execution only\n    // tx size cost stays visible.\n    Sapphire.padGas(100_000);\n  }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Choose a target that is greater or equal to the ",(0,r.jsx)(n.strong,{children:"worst\u2011case execution"})," for the function, with\na safety margin. You can measure worst\u2011case cost in tests (e.g., with\ntracers) and read the current execution gas via ",(0,r.jsx)(n.a,{href:"https://api.docs.oasis.io/sol/sapphire-contracts/contracts/Sapphire.sol/library.Sapphire.html#gasused",children:(0,r.jsx)(n.code,{children:"Sapphire.gasUsed()"})}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"when-to-use",children:"When to use"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Branches depend on confidential state/input and have materially different\nexecution cost."}),"\n",(0,r.jsx)(n.li,{children:"Success vs. revert paths would leak acceptance via fee differences."}),"\n",(0,r.jsx)(n.li,{children:"Before returning from functions that conditionally perform heavy computation."}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"when-not-to-rely-on-it-alone",children:["When ",(0,r.jsx)(n.em,{children:"not"})," to rely on it (alone)"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["It does ",(0,r.jsx)(n.strong,{children:"not"})," hide ",(0,r.jsx)(n.strong,{children:"transaction size"})," (calldata length). Different\u2011length\ninputs will still lead to different total fees."]}),"\n",(0,r.jsxs)(n.li,{children:["It does not pad external contracts you call unless ",(0,r.jsx)(n.strong,{children:"they"})," also pad."]}),"\n",(0,r.jsx)(n.li,{children:"It is not a replacement for constant\u2011time logic where feasible."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"masking-input-size-guidance",children:"Masking input size (guidance)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Prefer fixed\u2011size ABI types (",(0,r.jsx)(n.code,{children:"bytes32"})," instead of ",(0,r.jsx)(n.code,{children:"bytes"}),") and pass\n",(0,r.jsx)(n.strong,{children:"hashes"})," of variable\u2011length data rather than the data itself."]}),"\n",(0,r.jsxs)(n.li,{children:["If variable\u2011length bytes/ciphertext must be sent, ",(0,r.jsx)(n.strong,{children:"pad client\u2011side to a\nfixed length or to bucketized sizes"})," (e.g., 256/512/1024 bytes) before\nencrypting/sending; strip padding inside the contract."]}),"\n",(0,r.jsx)(n.li,{children:"Bundle multiple fields into a fixed\u2011size envelope and parse lengths inside\nthe confidential execution."}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"simple-example",children:"Simple example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:"contract GasExample {\n  bytes32 tmp;\n\n  function constantMath(bool doMath, uint128 padTo) external {\n    if (doMath) {\n      bytes32 x;\n      for (uint256 i = 0; i < 100; i++) {\n        x = keccak256(abi.encodePacked(x, tmp));\n      }\n      tmp = x;\n    }\n    // Pads EVM execution only; tx size cost remains public.\n    Sapphire.padGas(padTo);\n  }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Both calls below will consume the ",(0,r.jsx)(n.strong,{children:"same execution gas"}),", while the\n",(0,r.jsx)(n.strong,{children:"transaction\u2011size gas"})," may still differ if calldata sizes differ. You can\nalso query the execution gas with ",(0,r.jsx)(n.a,{href:"https://api.docs.oasis.io/sol/sapphire-contracts/contracts/Sapphire.sol/library.Sapphire.html#gasused",children:(0,r.jsx)(n.code,{children:"Sapphire.gasUsed()"})}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"await contract.constantMath(true, 100000);\nawait contract.constantMath(false, 100000);\n"})})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},11470:(e,n,t)=>{t.d(n,{A:()=>k});var a=t(96540),r=t(34164),s=t(17559),i=t(23104),o=t(56347),l=t(205),c=t(57485),d=t(31682),u=t(70679);function h(e){return a.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function p(e){const{values:n,children:t}=e;return(0,a.useMemo)(()=>{const e=n??function(e){return h(e).map(({props:{value:e,label:n,attributes:t,default:a}})=>({value:e,label:n,attributes:t,default:a}))}(t);return function(e){const n=(0,d.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,t])}function m({value:e,tabValues:n}){return n.some(n=>n.value===e)}function x({queryString:e=!1,groupId:n}){const t=(0,o.W6)(),r=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,c.aZ)(r),(0,a.useCallback)(e=>{if(!r)return;const n=new URLSearchParams(t.location.search);n.set(r,e),t.replace({...t.location,search:n.toString()})},[r,t])]}function g(e){const{defaultValue:n,queryString:t=!1,groupId:r}=e,s=p(e),[i,o]=(0,a.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!m({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const t=n.find(e=>e.default)??n[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:n,tabValues:s})),[c,d]=x({queryString:t,groupId:r}),[h,g]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[t,r]=(0,u.Dv)(n);return[t,(0,a.useCallback)(e=>{n&&r.set(e)},[n,r])]}({groupId:r}),f=(()=>{const e=c??h;return m({value:e,tabValues:s})?e:null})();(0,l.A)(()=>{f&&o(f)},[f]);return{selectedValue:i,selectValue:(0,a.useCallback)(e=>{if(!m({value:e,tabValues:s}))throw new Error(`Can't select invalid tab value=${e}`);o(e),d(e),g(e)},[d,g,s]),tabValues:s}}var f=t(92303);const b={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var y=t(74848);function j({className:e,block:n,selectedValue:t,selectValue:a,tabValues:s}){const o=[],{blockElementScrollPositionUntilNextRender:l}=(0,i.a_)(),c=e=>{const n=e.currentTarget,r=o.indexOf(n),i=s[r].value;i!==t&&(l(n),a(i))},d=e=>{let n=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const t=o.indexOf(e.currentTarget)+1;n=o[t]??o[0];break}case"ArrowLeft":{const t=o.indexOf(e.currentTarget)-1;n=o[t]??o[o.length-1];break}}n?.focus()};return(0,y.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.A)("tabs",{"tabs--block":n},e),children:s.map(({value:e,label:n,attributes:a})=>(0,y.jsx)("li",{role:"tab",tabIndex:t===e?0:-1,"aria-selected":t===e,ref:e=>{o.push(e)},onKeyDown:d,onClick:c,...a,className:(0,r.A)("tabs__item",b.tabItem,a?.className,{"tabs__item--active":t===e}),children:n??e},e))})}function v({lazy:e,children:n,selectedValue:t}){const s=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=s.find(e=>e.props.value===t);return e?(0,a.cloneElement)(e,{className:(0,r.A)("margin-top--md",e.props.className)}):null}return(0,y.jsx)("div",{className:"margin-top--md",children:s.map((e,n)=>(0,a.cloneElement)(e,{key:n,hidden:e.props.value!==t}))})}function w(e){const n=g(e);return(0,y.jsxs)("div",{className:(0,r.A)(s.G.tabs.container,"tabs-container",b.tabList),children:[(0,y.jsx)(j,{...n,...e}),(0,y.jsx)(v,{...n,...e})]})}function k(e){const n=(0,f.A)();return(0,y.jsx)(w,{...e,children:h(e.children)},String(n))}},19365:(e,n,t)=>{t.d(n,{A:()=>i});t(96540);var a=t(34164);const r={tabItem:"tabItem_Ymn6"};var s=t(74848);function i({children:e,hidden:n,className:t}){return(0,s.jsx)("div",{role:"tabpanel",className:(0,a.A)(r.tabItem,t),hidden:n,children:e})}},28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>o});var a=t(96540);const r={},s=a.createContext(r);function i(e){const n=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);