"use strict";(globalThis.webpackChunkdocs_oasis_io=globalThis.webpackChunkdocs_oasis_io||[]).push([[1432],{8801:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>s,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"node/run-your-node/keymanager-node/key-manager-upgrade","title":"Upgrading Key Managers","description":"This guide will describe how to upgrade a key manager node.","source":"@site/docs/node/run-your-node/keymanager-node/key-manager-upgrade.md","sourceDirName":"node/run-your-node/keymanager-node","slug":"/node/run-your-node/keymanager-node/key-manager-upgrade","permalink":"/node/run-your-node/keymanager-node/key-manager-upgrade","draft":false,"unlisted":false,"editUrl":"https://github.com/oasisprotocol/docs/edit/main/docs/node/run-your-node/keymanager-node/key-manager-upgrade.md","tags":[],"version":"current","lastUpdatedAt":1761867754000,"frontMatter":{"sidebar_custom_props":{}},"sidebar":"operators","previous":{"title":"Signing Key Manager Policy","permalink":"/node/run-your-node/keymanager-node/signing-key-manager-policy"},"next":{"title":"Sentry Node","permalink":"/node/run-your-node/sentry-node"}}');var t=a(74848),i=a(28453);const o={sidebar_custom_props:{tags:void 0}},d="Upgrading Key Managers",s={},l=[{value:"About the Upgrade",id:"about-the-upgrade",level:2},{value:"Safe Upgrade Procedure",id:"safe-upgrade-procedure",level:2},{value:"Upgrade Nodes",id:"upgrade-nodes",level:3},{value:"After the Upgrade",id:"after-the-upgrade",level:3},{value:"Verifying Successful Replication",id:"verifying-successful-replication",level:4},{value:"Troubleshooting",id:"troubleshooting",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"upgrading-key-managers",children:"Upgrading Key Managers"})}),"\n",(0,t.jsx)(n.p,{children:"This guide will describe how to upgrade a key manager node."}),"\n",(0,t.jsx)(n.h2,{id:"about-the-upgrade",children:"About the Upgrade"}),"\n",(0,t.jsx)(n.p,{children:"Every key manager node contains all the keys used by confidential ParaTimes\ninside its TEE-encrypted state. The key material is sealed and can only be\ndecrypted by exactly the same TEE enclave running on the exactly same CPU. This\nmeans that newer key manager ParaTimes can not read the key material and that\nkey material can not be restored on another machine."}),"\n",(0,t.jsx)(n.admonition,{type:"danger",children:(0,t.jsx)(n.p,{children:"During a key manager node upgrade it is therefore essential that the key\nmaterial is not lost, not even due to an operational error or even a\ncatastrophically failed upgrade."})}),"\n",(0,t.jsx)(n.h2,{id:"safe-upgrade-procedure",children:"Safe Upgrade Procedure"}),"\n",(0,t.jsx)(n.p,{children:"A key manager node's upgrade procedure differs from other Oasis nodes upgrades\nbecause the upgraded node cannot unseal/decrypt the old key manager's state."}),"\n",(0,t.jsx)(n.p,{children:"To upgrade a key manager node, we need to delete the local state and let the\nkey manager's state replicate itself from other nodes. Only one key manager\nruntime in the configuration file can be present at once."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"In case you are running multiple key manager nodes always follow the safe\nupgrade procedure:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Keep approximately one half of nodes running the old version."}),"\n",(0,t.jsx)(n.li,{children:"Upgrade the other half."}),"\n",(0,t.jsx)(n.li,{children:"Wait for the ParaTime upgrade epoch."}),"\n",(0,t.jsxs)(n.li,{children:["Verify that secrets have been replicated ",(0,t.jsx)(n.a,{href:"#verifying-successful-replication",children:"as shown below"}),"."]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Verify again."})}),"\n",(0,t.jsx)(n.li,{children:"Upgrade the rest of the nodes."}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"upgrade-nodes",children:"Upgrade Nodes"}),"\n",(0,t.jsx)(n.p,{children:"To upgrade a key manager node, follow the next steps:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Stop the node."}),"\n",(0,t.jsxs)(n.li,{children:["Wipe its local state ",(0,t.jsx)(n.code,{children:"worker-local-storage.badger.db"}),", e.g.:"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"rm -rf runtimes/4000000000000000000000000000000000000000000000004a1a53dff2ae482d/worker-local-storage.badger.db/\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsxs)(n.li,{children:["Upgrade the key manager runtime:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["get the new ORC file (",(0,t.jsx)(n.a,{href:"../../network/mainnet#key-manager",children:"mainnet"}),", ",(0,t.jsx)(n.a,{href:"../../network/testnet#key-manager",children:"testnet"}),");"]}),"\n",(0,t.jsx)(n.li,{children:"update the configuration to replace the ORC file; and"}),"\n",(0,t.jsx)(n.li,{children:"restart the node."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:"Wait for the key material to get replicated from active nodes before\ncontinuing."}),"\n",(0,t.jsxs)(n.li,{children:["Verify that secrets have been replicated ",(0,t.jsx)(n.a,{href:"#verifying-successful-replication",children:"as shown below"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"after-the-upgrade",children:"After the Upgrade"}),"\n",(0,t.jsx)(n.h4,{id:"verifying-successful-replication",children:"Verifying Successful Replication"}),"\n",(0,t.jsxs)(n.p,{children:["After the upgrade epoch and when the key material is successfully replicated,\nthe ",(0,t.jsx)(n.code,{children:"control status"})," output should show ",(0,t.jsx)(n.code,{children:'keymanager.status="ready"'})," and\n",(0,t.jsx)(n.code,{children:"registration.descriptor.runtimes.0.extra_info"})," should contain a hash of the\nkey material state:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'$ oasis-node -a unix:/node/data/internal.sock control status\n...\n  "registration": {\n    "last_registration": "2023-02-06T08:40:30Z",\n    "descriptor": {\n...\n      "runtimes": [\n        {\n          "id": "4000000000000000000000000000000000000000000000004a1a53dff2ae482d",\n          "version": {\n            "minor": 3,\n            "patch": 3\n          },\n          "capabilities": {\n            "tee": {\n              "hardware": 1,\n...\n            }\n          },\n          "extra_info": "omlzaWduYXR1cmVYQG7nDuKTOUKAlJAfukdY6Xljox376lCLI0cIP0zPw2B8abJxa31j+NoQAWA0KZuHD41XPyICmjXDTpjDXukEEgVtaW5pdF9yZXNwb25zZaNoY2hlY2tzdW1YIEWZF5YaFQChstrZ9u1UdgyqZCagmNfghvyQna9WkmvyaWlzX3NlY3VyZfVvcG9saWN5X2NoZWNrc3VtWCCsrqRzYjx05t+KoCYz7wFSdKJ720g2LQBAsRKXmClMvw=="\n        }\n      ],\n      "roles": "key-manager",\n    }\n  }\n...\n  "keymanager": {\n    "status": "ready",\n    "may_generate": false,\n    "runtime_id": "4000000000000000000000000000000000000000000000004a1a53dff2ae482d",\n    "client_runtimes": [\n      "000000000000000000000000000000000000000000000000a6d1e3ebf60dff6c",\n      "0000000000000000000000000000000000000000000000000000000000000000"\n    ],\n    "access_list": [\n...\n    ],\n    "private_peers": [\n...\n    ]\n  }\n'})}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(n.p,{children:"If you forgot to wipe the key manager's state when upgrading, the upgraded Key\nManager will be unable to unseal the old state and will abort:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'{"level":"warn","module":"runtime","msg":"thread \'main\' panicked at \'runtime execution failed: Enclave panicked.\', runtime-loader/bin/main.rs:57:10","runtime_id":"4000000000000000000000000000000000000000000000004a1a53dff2ae482d","runtime_name":"keymanager","ts":"2022-11-11T13:38:18.805919693Z"}\n'})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},28453:(e,n,a)=>{a.d(n,{R:()=>o,x:()=>d});var r=a(96540);const t={},i=r.createContext(t);function o(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);