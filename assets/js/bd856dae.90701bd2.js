"use strict";(globalThis.webpackChunkdocs_oasis_io=globalThis.webpackChunkdocs_oasis_io||[]).push([[9080],{28453:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>a});var o=i(96540);const r={},s=o.createContext(r);function t(e){const n=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),o.createElement(s.Provider,{value:n},e.children)}},84255:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"build/rofl/workflow/containerize-app","title":"Containerize an App","description":"Containerize your app inside a Docker-like container","source":"@site/docs/build/rofl/workflow/containerize-app.mdx","sourceDirName":"build/rofl/workflow","slug":"/build/rofl/workflow/containerize-app","permalink":"/build/rofl/workflow/containerize-app","draft":false,"unlisted":false,"editUrl":"https://github.com/oasisprotocol/oasis-sdk/edit/main/docs/rofl/workflow/containerize-app.mdx","tags":[],"version":"current","lastUpdatedAt":1761563757000,"frontMatter":{"description":"Containerize your app inside a Docker-like container","sidebar_custom_props":{}},"sidebar":"developers","previous":{"title":"Prerequisites","permalink":"/build/rofl/workflow/prerequisites"},"next":{"title":"Init","permalink":"/build/rofl/workflow/init"}}');var r=i(74848),s=i(28453);const t={description:"Containerize your app inside a Docker-like container",sidebar_custom_props:{tags:void 0}},a="Containerize an App",c={},l=[{value:"Dockerfile",id:"dockerfile",level:2},{value:"Compose",id:"compose",level:2},{value:"Adjust <code>image:</code> field to fit your needs",id:"adjust-image-field-to-fit-your-needs",level:3},{value:"Build and Push",id:"build-and-push",level:2},{value:"Pin Your Image Hash",id:"pin-your-image-hash",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"containerize-an-app",children:"Containerize an App"})}),"\n",(0,r.jsxs)(n.p,{children:["Services are best maintained if they are run in a ",(0,r.jsx)(n.strong,{children:"controlled environment"}),"\nalso known as ",(0,r.jsx)(n.em,{children:"a container"}),". This includes the exact version of the operating\nsystem, both system and user libraries, and your carefully configured service.\nThe image of the container is uploaded to an ",(0,r.jsx)(n.em,{children:"OCI file server"})," (e.g.\n",(0,r.jsx)(n.a,{href:"https://docker.io",children:"docker.io"}),", ",(0,r.jsx)(n.a,{href:"https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry",children:"ghcr.io"}),") from where the server hosting your bot downloads it."]}),"\n",(0,r.jsx)(n.p,{children:"Let's have the following project consisting of two files:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"my-bot\n\u251c\u2500\u2500 bot.py           # A python bot script\n\u2514\u2500\u2500 requirements.txt # Python dependencies\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For containerization we will use ",(0,r.jsx)(n.a,{href:"https://www.docker.com/",children:"Docker"}),", but you can also use\nalternatives such as ",(0,r.jsx)(n.a,{href:"https://www.podman.io/",children:"Podman"}),". In fact, when your app is deployed to\na ROFL node the containers there will be orchestrated by Podman, so feel free to\nuse it instead for better compatibility."]}),"\n",(0,r.jsx)(n.h2,{id:"dockerfile",children:"Dockerfile"}),"\n",(0,r.jsxs)(n.p,{children:["Inside the project folder create a file called ",(0,r.jsx)(n.code,{children:"Dockerfile"}),". This will\ninstruct Docker to compile a ",(0,r.jsx)(n.strong,{children:"python-based image"})," and add ",(0,r.jsx)(n.strong,{children:"our python bot\nscript on top of it"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dockerfile",metastring:'title="Dockerfile"',children:'FROM python:alpine3.17\n\nWORKDIR /bot\nCOPY ./bot.py ./requirements.txt /bot\nRUN pip install -r requirements.txt\n\nENTRYPOINT ["python", "bot.py"]\n'})}),"\n",(0,r.jsx)(n.h2,{id:"compose",children:"Compose"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://docs.docker.com/reference/compose-file/",children:"Docker Compose"})," orchestrates your containers. It makes sure\nthey are spun up in correct order, defines storage points, networking and other\nfunctionalities. Create ",(0,r.jsx)(n.code,{children:"compose.yaml"})," with the following example content:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="compose.yaml"',children:'services:\n  python-bot:\n    build: .\n    image: "docker.io/YOUR_USERNAME/YOUR_PROJECT"\n    platform: linux/amd64\n    environment:\n      - TOKEN=${TOKEN}\n'})}),"\n",(0,r.jsxs)(n.h3,{id:"adjust-image-field-to-fit-your-needs",children:["Adjust ",(0,r.jsx)(n.code,{children:"image:"})," field to fit your needs"]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"image:"})," field(s) in ",(0,r.jsx)(n.code,{children:"compose.yaml"})," above must point to a ",(0,r.jsx)(n.strong,{children:"publicly\naccessible OCI registry"})," where your image will be downloaded from for\nexecution."]}),"\n",(0,r.jsxs)(n.p,{children:["In your case replace the ",(0,r.jsx)(n.code,{children:"image:"})," field with a fully qualified domain of the OCI\nserver you use followed by your username, for example:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"docker.io/your_username/my-bot"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"ghcr.io/your_username/my-bot"})}),"\n"]}),"\n",(0,r.jsx)(n.admonition,{title:"Always specify FQDN image URL",type:"warning",children:(0,r.jsxs)(n.p,{children:["When specifying the container image URL, make sure to use fully qualified domain\nname e.g. ",(0,r.jsx)(n.code,{children:"docker.io/ollama/ollama"})," and not just ",(0,r.jsx)(n.code,{children:"ollama/ollama"}),"."]})}),"\n",(0,r.jsx)(n.h2,{id:"build-and-push",children:"Build and Push"}),"\n",(0,r.jsxs)(n.p,{children:["Build the container image and tag it using ",(0,r.jsx)(n.code,{children:"docker compose"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"docker compose build\n"})}),"\n",(0,r.jsxs)(n.admonition,{type:"tip",children:[(0,r.jsx)(n.p,{children:"You can also test the compose setup locally with:"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"docker compose up\n"})}),(0,r.jsx)(n.p,{children:"To stop it:"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"docker compose down\n"})})]}),"\n",(0,r.jsxs)(n.p,{children:["After building and tagging the images you need to push the container images to\npublicly accessible OCI registry (e.g. ",(0,r.jsx)(n.a,{href:"https://docker.io",children:"docker.io"}),", ",(0,r.jsx)(n.a,{href:"https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry",children:"ghcr.io"}),"). If this is the\nfirst time you're pushing images on your computer, you will first need to\nauthenticacte with:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"docker login\n"})}),"\n",(0,r.jsx)(n.p,{children:"Then run the following to upload the container images to the registry:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"docker compose push\n"})}),"\n",(0,r.jsx)(n.admonition,{title:"Make sure your image is public",type:"warning",children:(0,r.jsxs)(n.p,{children:["If you're pushing the image to GitHub containers for the first time, make sure\nyou ",(0,r.jsx)(n.a,{href:"https://docs.github.com/en/packages/learn-github-packages/configuring-a-packages-access-control-and-visibility#configuring-visibility-of-packages-for-your-personal-account",children:"configure public package visibility"}),"!"]})}),"\n",(0,r.jsx)(n.h2,{id:"pin-your-image-hash",children:"Pin Your Image Hash"}),"\n",(0,r.jsxs)(n.p,{children:["To prevent another container image being pulled inside ROFL, pin the ",(0,r.jsx)(n.strong,{children:"image\ndigest"})," inside ",(0,r.jsx)(n.code,{children:"compose.yaml"}),". Fetch the ",(0,r.jsx)(n.code,{children:"sha256:..."})," digest by invoking:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"docker images --digest\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Then append ",(0,r.jsx)(n.code,{children:"@"})," and the digest next to the image tag in your ",(0,r.jsx)(n.code,{children:"compose.yaml"}),", for\nexample:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'    image: "docker.io/MY_USERNAME/my-bot@sha256:9633593eb9e8395023cb0d926982602978466ec003efa189d94a34e7bea6ec0d"\n'})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);